<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <meta http-equiv="content-type" content="text/html; charset=UTF-8"/>
    <style type="text/css">
      #map_canvas { height: 480px;width: 640px }
      #navdata { font-family: arial, .lucida console., sans-serif }
    </style>
    <title>AR Drone autopilot interface</title>
    <script type="text/javascript">
      var map = null;
      var dronePosition = null;
      var droneIconPath = "http://www.psykokwak.com/pub/ardrone/icons/";
      var checkPoints = new Array();
      var checkPointsIndex = 0;
      var totalDistance = 0;
      var previousCheckPointLatLng = null;

      function initialize() {
        var myOptions = {
          zoom: 16,
          center: new google.maps.LatLng(48.85836, 2.294521),
          mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);

        google.maps.event.addListener(map, 'click', function(event) {
          if (previousCheckPointLatLng == null) return ;
          checkPoints[checkPointsIndex++] = event.latLng;
          addCheckPoint(event.latLng, checkPointsIndex);
          document.getElementById("button_play").disabled = false;
          totalDistance += distanceBetweenPoints(
                           previousCheckPointLatLng.lat(), previousCheckPointLatLng.lng(),
                           event.latLng.lat(), event.latLng.lng());


          document.getElementById("distance_play").innerHTML = Math.round(totalDistance);
        });
      }

      function loadScript() {
        var script = document.createElement("script");
        script.type = "text/javascript";
        script.src = "http://maps.google.com/maps/api/js?libraries=geometry&sensor=false&callback=initialize";
        document.body.appendChild(script);
      }

      function distanceBetweenPoints(lat1, lon1, lat2, lon2) {
        return google.maps.geometry.spherical.computeDistanceBetween(
          new google.maps.LatLng(lat1, lon1),
          new google.maps.LatLng(lat2, lon2));
      }

      function addCheckPoint(latLng, index) {
        new google.maps.Marker({
            position: latLng,
            map: map,
            title:"CheckPoint " + index
          });
      }

      function setLatLng(lat, lng, yaw) {
        if (map == null) return ;

        var pos = new google.maps.LatLng(lat, lng);
        map.panTo(pos);

        previousCheckPointLatLng = pos;

        orientation = orientationFromYaw(yaw);
        droneIcon = droneIconPath + "drone_" + orientation + ".png";

        if (dronePosition == null)
        {
          dronePosition = new google.maps.Marker({
            position: pos,
            map: map,
            icon:droneIcon,
            title:"Drone location"
          });
        }
        else
        {
          dronePosition.setPosition(pos);
          dronePosition.setIcon(droneIcon);
        }
      }

      function between(min, value, max) {
        if (value < min)
          return false;
        if (value >= max)
          return false;

        return true;
      }

      function orientationFromYaw(yaw) {
        pi = Math.PI;

        if (between(7*pi/8, yaw, 8*pi/8))   return "S";
        if (between(5*pi/8, yaw, 7*pi/8))   return "SE";
        if (between(3*pi/8, yaw, 5*pi/8))   return "E";
        if (between(pi/8, yaw, 3*pi/8))     return "NE";
        if (between(-pi/8, yaw, pi/8))      return "N";
        if (between(-3*pi/8, yaw, -pi/8))   return "NO";
        if (between(-5*pi/8, yaw, -3*pi/8)) return "O";
        if (between(-7*pi/8, yaw, -5*pi/8)) return "SO";
        if (between(-8*pi/8, yaw, -7*pi/8)) return "S";
      }


      function nodesParse(rootNode) {
        yaw = 0;
        lat = 0;
        lng = 0;
        quality = 0;

        for (i = 0; i < rootNode.childNodes.length; i++)
        {
          n = rootNode.childNodes[i];

          if (n.nodeType != 1) continue;

          e = document.getElementById("id_" + n.nodeName);

          if (n.nodeName == "ardrone_running" || n.nodeName == "ardrone_flying" || n.nodeName == "ardrone_emergency")
          {
            if (n.attributes.getNamedItem("value").value == "1")
              e.innerHTML = "Yes";
            else
              e.innerHTML = "No";
          }

          if (n.nodeName == "ardrone_battery")
            e.innerHTML = (parseFloat(n.attributes.getNamedItem("value").value) * 100).toFixed(1);

          if (n.nodeName == "ardrone_altitude")
            e.innerHTML = parseFloat(n.attributes.getNamedItem("value").value);

          if (n.nodeName == "gps_altitude")
            e.innerHTML = parseFloat(n.attributes.getNamedItem("value").value);

          if (n.nodeName == "gps_speed")
            e.innerHTML = parseFloat(n.attributes.getNamedItem("value").value);

          if (n.nodeName == "gps_speed")
            e.innerHTML = parseFloat(n.attributes.getNamedItem("value").value);

          if (n.nodeName == "gps_quality") {
            v = n.attributes.getNamedItem("value").value;
            quality = parseInt(v);
            if (quality == 0) e.innerHTML = "no GPS Fix";
            if (quality == 1) e.innerHTML = "GPS Fix";
            if (quality == 2) e.innerHTML = "dGPS Fix";
          }

          if (n.nodeName == "gps_satellites")
            e.innerHTML = parseFloat(n.attributes.getNamedItem("value").value);

          // Set Compass Yaw
          if (n.nodeName == "compass_heading")
          {
            yaw = parseFloat(n.attributes.getNamedItem("value").value);
            e.innerHTML = (yaw * (180 / Math.PI)).toFixed(1);
          }

          // Set GPS Yaw
          if (n.nodeName == "gps_heading")
          {
            y = parseFloat(n.attributes.getNamedItem("value").value);
            e.innerHTML = (y * (180 / Math.PI)).toFixed(1);
          }

          // Set Latitude
          if (n.nodeName == "gps_coordinates")
          {
            lat = parseFloat(n.attributes.getNamedItem("lat").value);
            document.getElementById("id_gps_lat").innerHTML = lat;
          }

          // Set Longitude
          if (n.nodeName == "gps_coordinates")
            lng = parseFloat(n.attributes.getNamedItem("lng").value);
            document.getElementById("id_gps_lng").innerHTML = lng;
        }

//        if (quality > 0)
          setLatLng(lat, lng, yaw);
      }

      function ArrayToURL(array) {
        var pairs = [];
        for (var key in array)
          if (array.hasOwnProperty(key))
            pairs.push(encodeURIComponent(key) + '=' + encodeURIComponent(array[key].toString().replace(", ", "x"))); // FIXME: Quick Hack for parsing
        return pairs.join('&');
      }

      function executePath() {
        e = document.getElementById("button_altitude");
        altitude = parseInt(e.value);

        finalcheckPoints = checkPoints.slice(0);
        finalcheckPoints[checkPoints.length] = altitude;
        askurl("/dynamic/path?" + ArrayToURL(finalcheckPoints), 0);
      }

      function askurl(url, repeat) {
        var XhrObj = null;
        if(window.XMLHttpRequest) // Firefox
          XhrObj = new XMLHttpRequest();
        else
          if(window.ActiveXObject) // Internet Explorer
            XhrObj = new ActiveXObject("Microsoft.XMLHTTP");
          else
            alert("Pas d'ajax!");

        XhrObj.onreadystatechange = function () {
          if(XhrObj.readyState == 4 && XhrObj.status == 200)
          {
            if(XhrObj.responseXML.childNodes.length == 1) //FireFox
              nodesParse(XhrObj.responseXML.childNodes[0]);
            else //IE
              nodesParse(XhrObj.responseXML.childNodes[1]);

            if (repeat > 0)
            {
               var func = "askurl('"+url+"', "+repeat+")";
               setTimeout(func, repeat);
            }
          }
        }
        XhrObj.open("GET", url, true);
        XhrObj.setRequestHeader("Cache-Control","no-cache");
        XhrObj.send(null);
      }


      window.onload = loadScript;
      askurl("/dynamic/drone", 500);

    </script>
  </head>
  <body>
    <center><h2>AD.Drone autopilot interface</h2></center>
    <table width="100%" border="0">
      <tr>
        <td width="100%">
          <center><h3>Telemetry</h3></center>
          <div id="navdata">AR.Drone link : <span id="id_ardrone_running">Unknown</span></div>
          <div id="navdata">AR.Drone emergency : <span id="id_ardrone_emergency">Unknown</span></div>
          <div id="navdata">AR.Drone flying : <span id="id_ardrone_flying">Unknown</span></div>
          <div id="navdata">AR.Drone battery : <span id="id_ardrone_battery">Unknown</span> %</div>
          <div id="navdata">AR.Drone altitude (sonars based) : <span id="id_ardrone_altitude">Unknown</span> meters</div>
          <div id="navdata">AR.Drone altitude (gps based) : <span id="id_gps_altitude">Unknown</span> meters</div>
          <div id="navdata">AR.Drone GPS coordinates : <span id="id_gps_lat">Unknown</span>, <span id="id_gps_lng">Unknown</span></div>
          <div id="navdata">AR.Drone heading (gps based) : <span id="id_gps_heading">Unknown</span>°</div>
          <div id="navdata">AR.Drone heading (compass based) : <span id="id_compass_heading">Unknown</span>°</div>
          <div id="navdata">AR.Drone speed : <span id="id_gps_speed">Unknown</span> km/h</div>
          <div id="navdata">GPS link : <span id="id_gps_quality">Unknown</span></div>
          <div id="navdata">GPS Sat : <span id="id_gps_satellites">Unknown</span> satellites</div>
          <hr>
          <center>
            <input type="button" value="Emergency" OnClick="askurl('/dynamic/drone?emergency', 0)" />
            <input type="button" value="Takeoff" OnClick="askurl('/dynamic/drone?takeoff', 0)" />
            <input type="button" value="Landing" OnClick="askurl('/dynamic/drone?landing', 0)" />
            <input type="button" value="Trim" OnClick="askurl('/dynamic/drone?trim', 0)" />
          <center>
          <hr>
          <center>
            <input type="button" value=":: Play Path ::" id="button_play" disabled="disabled" OnClick="executePath()" />
            <br>
            <span>Altitude : </span><input type="text" value="3" size="2" id="button_altitude" /><span> meters requested.</span>
            <br>
            <div>Total distance Path : <span id="distance_play">0</span> meters.</div>
          </center>
          <hr>
          <center>
            <div>NMEA Logger</div>
            <input type="button" value="start" OnClick="askurl('/dynamic/logger?start', 0)" />
            <input type="button" value="stop" OnClick="askurl('/dynamic/logger?stop', 0)" />
            <br>
            <a href="/nmea.log">Download log</a>
          </center>
        </td>
        <td align="right"><div id="map_canvas"></div></td>
      </tr>
    </table>
  </body>
</html>
