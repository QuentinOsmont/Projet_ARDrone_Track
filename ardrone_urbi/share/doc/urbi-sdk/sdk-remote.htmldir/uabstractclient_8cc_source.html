<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Urbi SDK Remote: uabstractclient.cc Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.7.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>File&nbsp;Members</span></a></li>
    </ul>
  </div>
  <div class="navpath">
    <ul>
      <li><a class="el" href="dir_03c25b13d14c5db4475ec8bbd24b0f1f.html">source</a>      </li>
      <li><a class="el" href="dir_218aef791fc34308040010d988450d4d.html">sdk-remote</a>      </li>
      <li><a class="el" href="dir_8936cf83ad6d7e6892ca1b54c991a702.html">src</a>      </li>
      <li><a class="el" href="dir_c4976274f85a76007331c539dd7f749b.html">liburbi</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>uabstractclient.cc</h1>  </div>
</div>
<div class="contents">
<a href="uabstractclient_8cc.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 <span class="comment">/*</span>
<a name="l00002"></a>00002 <span class="comment"> * Copyright (C) 2005-2010, Gostai S.A.S.</span>
<a name="l00003"></a>00003 <span class="comment"> *</span>
<a name="l00004"></a>00004 <span class="comment"> * This software is provided &quot;as is&quot; without warranty of any kind,</span>
<a name="l00005"></a>00005 <span class="comment"> * either expressed or implied, including but not limited to the</span>
<a name="l00006"></a>00006 <span class="comment"> * implied warranties of fitness for a particular purpose.</span>
<a name="l00007"></a>00007 <span class="comment"> *</span>
<a name="l00008"></a>00008 <span class="comment"> * See the LICENSE file for more information.</span>
<a name="l00009"></a>00009 <span class="comment"> */</span>
<a name="l00010"></a>00010 
<a name="l00012"></a>00012 
<a name="l00013"></a>00013 <span class="preprocessor">#include &lt;algorithm&gt;</span>
<a name="l00014"></a>00014 <span class="preprocessor">#include &lt;libport/cassert&gt;</span>
<a name="l00015"></a>00015 <span class="preprocessor">#include &lt;libport/cerrno&gt;</span>
<a name="l00016"></a>00016 <span class="preprocessor">#include &lt;libport/cmath&gt;</span>
<a name="l00017"></a>00017 <span class="preprocessor">#include &lt;libport/cstdlib&gt;</span>
<a name="l00018"></a>00018 <span class="preprocessor">#include &lt;fstream&gt;</span>
<a name="l00019"></a>00019 <span class="preprocessor">#include &lt;iostream&gt;</span>
<a name="l00020"></a>00020 
<a name="l00021"></a>00021 <span class="preprocessor">#include &lt;libport/format.hh&gt;</span>
<a name="l00022"></a>00022 <span class="preprocessor">#include &lt;libport/lexical-cast.hh&gt;</span>
<a name="l00023"></a>00023 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;libport/cstdio&gt;</span>
<a name="l00025"></a>00025 <span class="preprocessor">#include &lt;libport/cstring&gt;</span>
<a name="l00026"></a>00026 <span class="preprocessor">#include &lt;libport/containers.hh&gt;</span>
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;libport/debug.hh&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor">#include &lt;libport/escape.hh&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;libport/lexical-cast.hh&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;libport/lockable.hh&gt;</span>
<a name="l00031"></a>00031 <span class="preprocessor">#include &lt;libport/sys/stat.h&gt;</span>
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;libport/unistd.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;libport/windows.hh&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;<a class="code" href="uabstractclient_8hh.html" title="Definition of the URBI interface class.">urbi/uabstractclient.hh</a>&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;<a class="code" href="uconversion_8hh.html" title="Conversion of sounds and images.">urbi/uconversion.hh</a>&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;<a class="code" href="umessage_8hh.html">urbi/umessage.hh</a>&gt;</span>
<a name="l00038"></a>00038 <span class="preprocessor">#include &lt;<a class="code" href="utag_8hh.html">urbi/utag.hh</a>&gt;</span>
<a name="l00039"></a>00039 
<a name="l00040"></a>00040 <span class="preprocessor">#include &lt;<a class="code" href="compatibility_8hh.html">liburbi/compatibility.hh</a>&gt;</span>
<a name="l00041"></a>00041 
<a name="l00042"></a>00042 <a class="code" href="uobject-common_8cc.html#a2732044fb4a85ef4edd80daf89b37efb">GD_CATEGORY</a>(UAbstractClient);
<a name="l00043"></a>00043 
<a name="l00044"></a>00044 <span class="keyword">namespace </span>urbi
<a name="l00045"></a>00045 {
<a name="l00046"></a>00046 
<a name="l00048"></a><a class="code" href="namespaceurbi.html#ac9433e2a7062103d7feee4276d52c0ce">00048</a>   <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="namespaceurbi.html#ac9433e2a7062103d7feee4276d52c0ce" title="Fake tag to treat error message with tags.">tag_error</a> = <span class="stringliteral">&quot;[error]&quot;</span>;
<a name="l00050"></a><a class="code" href="namespaceurbi.html#a1984085fcfa97e463e2959160ba461fc">00050</a>   <span class="keyword">const</span> <span class="keywordtype">char</span>* <a class="code" href="namespaceurbi.html#a1984085fcfa97e463e2959160ba461fc" title="Fake tag to catch all the messages.">tag_wildcard</a> = <span class="stringliteral">&quot;[wildcard]&quot;</span>;
<a name="l00051"></a>00051 
<a name="l00052"></a>00052   std::ostream&amp;
<a name="l00053"></a>00053   <a class="code" href="namespaceurbi.html#a121241a7095d14c8f8c3b4fdf9152208" title="Return a stream for error, preferrably the one the defaultClient.">default_stream</a>()
<a name="l00054"></a>00054   {
<a name="l00055"></a>00055     <span class="keywordflow">return</span> (<a class="code" href="namespaceurbi.html#a9586227e53bd2feae43f1010afc1d6fa" title="Return the first UClient created by the program.">getDefaultClient</a>()
<a name="l00056"></a>00056             ? ((<a class="code" href="classurbi_1_1_u_abstract_client.html" title="Interface for an URBI wrapper object.">UAbstractClient</a>*)<a class="code" href="namespaceurbi.html#a9586227e53bd2feae43f1010afc1d6fa" title="Return the first UClient created by the program.">getDefaultClient</a>())-&gt;stream_get()
<a name="l00057"></a>00057             : std::cerr);
<a name="l00058"></a>00058   }
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 
<a name="l00061"></a>00061   <span class="comment">/*-------------.</span>
<a name="l00062"></a>00062 <span class="comment">  | UCallbacks.  |</span>
<a name="l00063"></a>00063 <span class="comment">  `-------------*/</span>
<a name="l00064"></a>00064 
<a name="l00065"></a><a class="code" href="namespaceurbi.html#a5d8078ec911195690fa3b3bbfe794671">00065</a>   <span class="keyword">enum</span> <a class="code" href="namespaceurbi.html#a5d8078ec911195690fa3b3bbfe794671">UCallbackType</a>
<a name="l00066"></a>00066   {
<a name="l00067"></a><a class="code" href="namespaceurbi.html#a5d8078ec911195690fa3b3bbfe794671acda7941fc239ba4151b650362c048e6c">00067</a>     UCB_,
<a name="l00068"></a><a class="code" href="namespaceurbi.html#a5d8078ec911195690fa3b3bbfe794671abb5cfde89387bc3c0203e9ecbde2e210">00068</a>     UCB_C,
<a name="l00069"></a>00069   };
<a name="l00070"></a>00070 
<a name="l00071"></a><a class="code" href="namespaceurbi.html#ae09eb3b0d802d03d0ddb35d494f8555c">00071</a>   <span class="keyword">static</span> <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a> <a class="code" href="namespaceurbi.html#ae09eb3b0d802d03d0ddb35d494f8555c">nextId</a>;
<a name="l00072"></a>00072 
<a name="l00073"></a>00073   <span class="keyword">class </span>UCallbackWrapperCB: <span class="keyword">public</span> <a class="code" href="classurbi_1_1_u_callback_wrapper.html" title="Wrapper around a callback function. Use callback() to create them.">UCallbackWrapper</a>
<a name="l00074"></a>00074   {
<a name="l00075"></a>00075     <a class="code" href="namespaceurbi.html#a930fe72c26550eea59562f9ee4fbeea3" title="Callback prototypes.">UCallback</a> cb;
<a name="l00076"></a>00076   <span class="keyword">public</span>:
<a name="l00077"></a>00077     UCallbackWrapperCB(<a class="code" href="namespaceurbi.html#a930fe72c26550eea59562f9ee4fbeea3" title="Callback prototypes.">UCallback</a> cb)
<a name="l00078"></a>00078       : cb(cb)
<a name="l00079"></a>00079     {
<a name="l00080"></a>00080     }
<a name="l00081"></a>00081     <span class="keyword">virtual</span> <a class="code" href="namespaceurbi.html#a63f30f52002e7e7f853a12a8c1172f41" title="Return values for the callcack functions.">UCallbackAction</a> operator()(<span class="keyword">const</span> <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a>&amp; msg)
<a name="l00082"></a>00082     {
<a name="l00083"></a>00083       <span class="keywordflow">return</span> cb(msg);
<a name="l00084"></a>00084     }
<a name="l00085"></a>00085   };
<a name="l00086"></a>00086 
<a name="l00087"></a>00087 
<a name="l00088"></a>00088   <span class="keyword">class </span>UCallbackWrapperCCB: <span class="keyword">public</span> UCallbackWrapper
<a name="l00089"></a>00089   {
<a name="l00090"></a>00090     <a class="code" href="namespaceurbi.html#a7faaf004fc749ed1033937949137424b">UCustomCallback</a> cb;
<a name="l00091"></a>00091     <span class="keywordtype">void</span> * data;
<a name="l00092"></a>00092   <span class="keyword">public</span>:
<a name="l00093"></a>00093     UCallbackWrapperCCB(<a class="code" href="namespaceurbi.html#a7faaf004fc749ed1033937949137424b">UCustomCallback</a> cb, <span class="keywordtype">void</span>* data)
<a name="l00094"></a>00094       : cb(cb)
<a name="l00095"></a>00095       , data(data)
<a name="l00096"></a>00096     {
<a name="l00097"></a>00097     }
<a name="l00098"></a>00098     <span class="keyword">virtual</span> <a class="code" href="namespaceurbi.html#a63f30f52002e7e7f853a12a8c1172f41" title="Return values for the callcack functions.">UCallbackAction</a> operator()(<span class="keyword">const</span> UMessage&amp; msg)
<a name="l00099"></a>00099     {
<a name="l00100"></a>00100       <span class="keywordflow">return</span> cb(data, msg);
<a name="l00101"></a>00101     }
<a name="l00102"></a>00102   };
<a name="l00103"></a>00103 
<a name="l00104"></a>00104 
<a name="l00105"></a>00105   <span class="comment">/*-------------------.</span>
<a name="l00106"></a>00106 <span class="comment">  | UClientStreambuf.  |</span>
<a name="l00107"></a>00107 <span class="comment">  `-------------------*/</span>
<a name="l00108"></a>00108 
<a name="l00109"></a>00109   <span class="keyword">class </span>UClientStreambuf: <span class="keyword">public</span> std::streambuf
<a name="l00110"></a>00110   {
<a name="l00111"></a>00111   <span class="keyword">public</span>:
<a name="l00112"></a>00112     UClientStreambuf(UAbstractClient* cl)
<a name="l00113"></a>00113       : client_(cl)
<a name="l00114"></a>00114     {
<a name="l00115"></a>00115     }
<a name="l00116"></a>00116 
<a name="l00118"></a>00118     UAbstractClient*
<a name="l00119"></a>00119     <a class="code" href="namespaceurbi.html#afd5af773c0495c34d747f77496b512a7">client_get</a>()
<a name="l00120"></a>00120     {
<a name="l00121"></a>00121       <span class="keywordflow">return</span> client_;
<a name="l00122"></a>00122     }
<a name="l00123"></a>00123 
<a name="l00124"></a>00124   <span class="keyword">protected</span>:
<a name="l00125"></a>00125     <span class="keyword">virtual</span> <span class="keywordtype">int</span> overflow(<span class="keywordtype">int</span> c = EOF);
<a name="l00126"></a>00126     <span class="comment">// Override std::basic_streambuf&lt;_CharT, _Traits&gt;::xsputn.</span>
<a name="l00127"></a>00127     <span class="keyword">virtual</span> std::streamsize xsputn(<span class="keyword">const</span> <span class="keywordtype">char</span>* s, std::streamsize n);
<a name="l00128"></a>00128 
<a name="l00129"></a>00129   <span class="keyword">private</span>:
<a name="l00130"></a>00130     UAbstractClient* client_;
<a name="l00131"></a>00131   };
<a name="l00132"></a>00132 
<a name="l00133"></a>00133   <span class="keywordtype">int</span>
<a name="l00134"></a>00134   UClientStreambuf::overflow(<span class="keywordtype">int</span> c)
<a name="l00135"></a>00135   {
<a name="l00136"></a>00136     <span class="keywordflow">if</span> (c != EOF)
<a name="l00137"></a>00137     {
<a name="l00138"></a>00138       <span class="keywordtype">char</span> ch = <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span><span class="keyword">&gt;</span>(c);
<a name="l00139"></a>00139       xsputn(&amp;ch, 1);
<a name="l00140"></a>00140     }
<a name="l00141"></a>00141     <span class="keywordflow">return</span> c;
<a name="l00142"></a>00142   }
<a name="l00143"></a>00143 
<a name="l00144"></a>00144   std::streamsize
<a name="l00145"></a>00145   UClientStreambuf::xsputn(<span class="keyword">const</span> <span class="keywordtype">char</span>* s, std::streamsize n)
<a name="l00146"></a>00146   {
<a name="l00147"></a>00147     client_-&gt;sendBufferLock.lock();
<a name="l00148"></a>00148     <span class="keywordtype">size_t</span> clen = strlen(client_-&gt;sendBuffer);
<a name="l00149"></a>00149     <span class="keywordflow">if</span> (client_-&gt;sendBufSize &lt; clen + 1 + n)
<a name="l00150"></a>00150     {
<a name="l00151"></a>00151       client_-&gt;effective_send(client_-&gt;sendBuffer);
<a name="l00152"></a>00152       client_-&gt;sendBuffer[0] = 0;
<a name="l00153"></a>00153       client_-&gt;effectiveSend(s, n);
<a name="l00154"></a>00154       client_-&gt;sendBufferLock.unlock();
<a name="l00155"></a>00155       <span class="keywordflow">return</span> n;
<a name="l00156"></a>00156     }
<a name="l00157"></a>00157     memcpy(client_-&gt;sendBuffer + clen, s, n);
<a name="l00158"></a>00158     client_-&gt;sendBuffer[clen+n] = 0;
<a name="l00159"></a>00159     <span class="keywordflow">if</span> (strpbrk(client_-&gt;sendBuffer+clen, <span class="stringliteral">&quot;&amp;|;,&quot;</span>))
<a name="l00160"></a>00160     {
<a name="l00161"></a>00161       client_-&gt;effective_send(client_-&gt;sendBuffer);
<a name="l00162"></a>00162       client_-&gt;sendBuffer[0] = 0;
<a name="l00163"></a>00163     }
<a name="l00164"></a>00164     client_-&gt;sendBufferLock.unlock();
<a name="l00165"></a>00165     <span class="keywordflow">return</span> n;
<a name="l00166"></a>00166   }
<a name="l00167"></a>00167 
<a name="l00168"></a>00168 
<a name="l00169"></a>00169   <span class="comment">/*------------------.</span>
<a name="l00170"></a>00170 <span class="comment">  | UAbstractClient.  |</span>
<a name="l00171"></a>00171 <span class="comment">  `------------------*/</span>
<a name="l00172"></a>00172 
<a name="l00173"></a>00173 
<a name="l00174"></a>00174   <span class="keyword">const</span> <span class="keywordtype">char</span>* UAbstractClient::CLIENTERROR_TAG = <span class="stringliteral">&quot;client_error&quot;</span>;
<a name="l00175"></a>00175 
<a name="l00176"></a>00176   <span class="keywordtype">void</span>
<a name="l00177"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#ad23d1fff07aa8987bb7f80500afb2f31">00177</a>   UAbstractClient::bins_clear()
<a name="l00178"></a>00178   {
<a name="l00179"></a>00179     <span class="keywordflow">for</span> (<span class="comment">/* nothing */</span>; !<a class="code" href="classurbi_1_1_u_abstract_client.html#af0c90d1a318e4794c411beb5920da6fc" title="Bin object for this command.">bins</a>.empty(); <a class="code" href="classurbi_1_1_u_abstract_client.html#af0c90d1a318e4794c411beb5920da6fc" title="Bin object for this command.">bins</a>.pop_front())
<a name="l00180"></a>00180       <a class="code" href="classurbi_1_1_u_abstract_client.html#af0c90d1a318e4794c411beb5920da6fc" title="Bin object for this command.">bins</a>.front().clear();
<a name="l00181"></a>00181   }
<a name="l00182"></a>00182 
<a name="l00183"></a>00183   <span class="keywordtype">void</span>
<a name="l00184"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a0752fafd9cfaa6f452d0963314c076a9">00184</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a0752fafd9cfaa6f452d0963314c076a9" title="Pass the given UMessage to all registered callbacks with the corresponding tag, as if it were comming...">UAbstractClient::notifyCallbacks</a>(<span class="keyword">const</span> <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a>&amp; msg)
<a name="l00185"></a>00185   {
<a name="l00186"></a>00186     <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.lock();
<a name="l00187"></a>00187     <span class="keywordtype">bool</span> inc = <span class="keyword">false</span>;
<a name="l00188"></a>00188     <span class="keywordflow">for</span> (callbacks_type::iterator it = <a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.begin();
<a name="l00189"></a>00189          it != <a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.end();
<a name="l00190"></a>00190          inc ? it : it++, inc = <span class="keyword">false</span>)
<a name="l00191"></a>00191     {
<a name="l00192"></a>00192       <span class="keywordflow">if</span> (msg.<a class="code" href="classurbi_1_1_u_message.html#a663f67700bf8eaa3fcb859e018466403" title="Associated tag.">tag</a> == it-&gt;tag
<a name="l00193"></a>00193           || (libport::streq(it-&gt;tag, <a class="code" href="namespaceurbi.html#ac9433e2a7062103d7feee4276d52c0ce" title="Fake tag to treat error message with tags.">tag_error</a>) &amp;&amp; msg.<a class="code" href="classurbi_1_1_u_message.html#a49559da7ba6d92767746adf62035a2c3" title="The type of this message.">type</a> == <a class="code" href="namespaceurbi.html#af4858e704e4932543908706b6b483b69a66c0b550b14662b02dabc72637479c3f" title="Messages prefixed by !!!.">MESSAGE_ERROR</a>)
<a name="l00194"></a>00194           <span class="comment">// The wild card does not match tags starting with</span>
<a name="l00195"></a>00195           <span class="comment">// TAG_PRIVATE_PREFIX.</span>
<a name="l00196"></a>00196           || (libport::streq(it-&gt;tag, <a class="code" href="namespaceurbi.html#a1984085fcfa97e463e2959160ba461fc" title="Fake tag to catch all the messages.">tag_wildcard</a>)
<a name="l00197"></a>00197               &amp;&amp; msg.<a class="code" href="classurbi_1_1_u_message.html#a663f67700bf8eaa3fcb859e018466403" title="Associated tag.">tag</a>.compare(0,
<a name="l00198"></a>00198                                  <span class="keyword">sizeof</span> <a class="code" href="utag_8hh.html#a1ed2cbb122b80126ee19a4a663474bd2" title="A prefix for tags with which internal messages are exchanged.">TAG_PRIVATE_PREFIX</a> - 1,
<a name="l00199"></a>00199                                  <a class="code" href="utag_8hh.html#a1ed2cbb122b80126ee19a4a663474bd2" title="A prefix for tags with which internal messages are exchanged.">TAG_PRIVATE_PREFIX</a>)))
<a name="l00200"></a>00200       {
<a name="l00201"></a>00201         <a class="code" href="namespaceurbi.html#a63f30f52002e7e7f853a12a8c1172f41" title="Return values for the callcack functions.">UCallbackAction</a> ua = it-&gt;callback(msg);
<a name="l00202"></a>00202         <span class="keywordflow">if</span> (ua == <a class="code" href="namespaceurbi.html#a63f30f52002e7e7f853a12a8c1172f41a8119715698c2d49b16dc9dccf478f3e0">URBI_REMOVE</a>)
<a name="l00203"></a>00203         {
<a name="l00204"></a>00204           <span class="keyword">delete</span> &amp;it-&gt;callback;
<a name="l00205"></a>00205           it = <a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.erase(it);
<a name="l00206"></a>00206           inc = <span class="keyword">true</span>;
<a name="l00207"></a>00207         }
<a name="l00208"></a>00208       }
<a name="l00209"></a>00209     }
<a name="l00210"></a>00210     <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.unlock();
<a name="l00211"></a>00211   }
<a name="l00212"></a>00212 
<a name="l00213"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a39bfbdf6c5c906b5deb349c823e175b5">00213</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a39bfbdf6c5c906b5deb349c823e175b5" title="Create a new instance and connect to the Urbi server.">UAbstractClient::UAbstractClient</a>(<span class="keyword">const</span> std::string&amp; host,
<a name="l00214"></a>00214                                    <span class="keywordtype">unsigned</span> port,
<a name="l00215"></a>00215                                    <span class="keywordtype">size_t</span> buflen,
<a name="l00216"></a>00216                                    <span class="keywordtype">bool</span> server)
<a name="l00217"></a>00217     : std::ostream(new UClientStreambuf(this))
<a name="l00218"></a>00218     , closed_ (false)
<a name="l00219"></a>00219     , sendBufferLock()
<a name="l00220"></a>00220     , listLock()
<a name="l00221"></a>00221     , host_(host)
<a name="l00222"></a>00222     , port_(port)
<a name="l00223"></a>00223     , server_(server)
<a name="l00224"></a>00224     , sendBufSize(buflen)
<a name="l00225"></a>00225     , recvBufSize(buflen)
<a name="l00226"></a>00226     , rc(0)
<a name="l00227"></a>00227 
<a name="l00228"></a>00228     , recvBuffer(new char[buflen])
<a name="l00229"></a>00229     , recvBufferPosition(0)
<a name="l00230"></a>00230     , sendBuffer(new char[buflen])
<a name="l00231"></a>00231 
<a name="l00232"></a>00232     , kernelMajor_(-1)
<a name="l00233"></a>00233     , kernelMinor_(-1)
<a name="l00234"></a>00234     , binaryBuffer(0)
<a name="l00235"></a>00235     , parsePosition(0)
<a name="l00236"></a>00236     , inString(false)
<a name="l00237"></a>00237     , nBracket(0)
<a name="l00238"></a>00238     , binaryMode(false)
<a name="l00239"></a>00239     , system(false)
<a name="l00240"></a>00240     , init_(true)
<a name="l00241"></a>00241     , counter_(0)
<a name="l00242"></a>00242     , stream_(this)
<a name="l00243"></a>00243   {
<a name="l00244"></a>00244     exceptions(std::ostream::eofbit | std::ostream::failbit |
<a name="l00245"></a>00245                std::ostream::badbit);
<a name="l00246"></a>00246     <a class="code" href="classurbi_1_1_u_abstract_client.html#acd337bf267d7768a679ee98a9b693317" title="This, as a stream.">stream_get</a>().setf(std::ios::fixed);
<a name="l00247"></a>00247     <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>[0] = 0;
<a name="l00248"></a>00248     <a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>[0] = 0;
<a name="l00249"></a>00249   }
<a name="l00250"></a>00250 
<a name="l00251"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a28e23592d3e5037b36aa9c708b5b623c">00251</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a28e23592d3e5037b36aa9c708b5b623c">UAbstractClient::~UAbstractClient</a>()
<a name="l00252"></a>00252   {
<a name="l00253"></a>00253     <span class="comment">// No more default client if delete.</span>
<a name="l00254"></a>00254     <span class="keywordflow">if</span> ((<span class="keywordtype">void</span>*)<a class="code" href="namespaceurbi.html#a9586227e53bd2feae43f1010afc1d6fa" title="Return the first UClient created by the program.">getDefaultClient</a>() == (<span class="keywordtype">void</span>*)<span class="keyword">this</span>)
<a name="l00255"></a>00255       <a class="code" href="namespaceurbi.html#aef74fc0742be0966b175731a3806e8b0" title="Redefine the default client.">setDefaultClient</a>(0);
<a name="l00256"></a>00256     <span class="keyword">delete</span> [] <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>;
<a name="l00257"></a>00257     <span class="keyword">delete</span> [] <a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>;
<a name="l00258"></a>00258   }
<a name="l00259"></a>00259 
<a name="l00264"></a>00264   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00265"></a><a class="code" href="group___sending.html#ga17f11931cc39f95697e8ab21222372d0">00265</a>   <a class="code" href="group___sending.html#ga17f11931cc39f95697e8ab21222372d0" title="Lock the send buffer (for backward compatibility, will be removed in future versions).">UAbstractClient::startPack</a>()
<a name="l00266"></a>00266   {
<a name="l00267"></a>00267     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.lock();
<a name="l00268"></a>00268     <span class="keywordflow">return</span> 0;
<a name="l00269"></a>00269   }
<a name="l00270"></a>00270 
<a name="l00271"></a>00271   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00272"></a><a class="code" href="group___sending.html#ga9e161015bcbdd77d6722e2c7ead18871">00272</a>   <a class="code" href="group___sending.html#ga9e161015bcbdd77d6722e2c7ead18871" title="Unlock the send buffer (for backward compatibility, will be removed in future versions).">UAbstractClient::endPack</a>()
<a name="l00273"></a>00273   {
<a name="l00274"></a>00274     <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">error_type</a> res = <a class="code" href="classurbi_1_1_u_abstract_client.html#a4fe351ee52f67775fbf03bc4d1d6dd14" title="Bounce to effectiveSend() using strlen.">effective_send</a>(<a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>);
<a name="l00275"></a>00275     <a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>[0] = 0;
<a name="l00276"></a>00276     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.unlock();
<a name="l00277"></a>00277     <span class="keywordflow">return</span> res;
<a name="l00278"></a>00278   }
<a name="l00279"></a>00279 
<a name="l00280"></a>00280 
<a name="l00283"></a>00283   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00284"></a><a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b">00284</a>   <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">UAbstractClient::send</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* command, ...)
<a name="l00285"></a>00285   {
<a name="l00286"></a>00286     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>)
<a name="l00287"></a>00287       <span class="keywordflow">return</span> -1;
<a name="l00288"></a>00288     va_list arg;
<a name="l00289"></a>00289     va_start(arg, command);
<a name="l00290"></a>00290     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.lock();
<a name="l00291"></a>00291     <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a> = <a class="code" href="group___sending.html#ga652b271e0db64307ce69c7468d7fcd08" title="va_list version of pack.">vpack</a>(command, arg);
<a name="l00292"></a>00292     va_end(arg);
<a name="l00293"></a>00293     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a> &lt; 0)
<a name="l00294"></a>00294     {
<a name="l00295"></a>00295       <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.unlock();
<a name="l00296"></a>00296       <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>;
<a name="l00297"></a>00297     }
<a name="l00298"></a>00298     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a> = <a class="code" href="group___sending.html#ga9e161015bcbdd77d6722e2c7ead18871" title="Unlock the send buffer (for backward compatibility, will be removed in future versions).">endPack</a>();
<a name="l00299"></a>00299   }
<a name="l00300"></a>00300 
<a name="l00301"></a>00301   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00302"></a><a class="code" href="group___sending.html#gaafa3f26fd85e488ff94d859b5b16b7b8">00302</a>   <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">UAbstractClient::send</a>(<span class="keyword">const</span> <a class="code" href="classurbi_1_1_u_value.html" title="Container for a value that handles all types known to URBI.">UValue</a>&amp; v)
<a name="l00303"></a>00303   {
<a name="l00304"></a>00304     <span class="keywordflow">switch</span> (v.<a class="code" href="classurbi_1_1_u_value.html#a0300e8defe31b165b2b00ba190420f09">type</a>)
<a name="l00305"></a>00305     {
<a name="l00306"></a>00306     <span class="comment">// Bounce to UValue operator &lt;&lt; for those types.</span>
<a name="l00307"></a>00307     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#a5443afbb6251a2a6f54cbf3c32e59f3dad44dc6b3942ec1a12bcba660941673c1">DATA_DOUBLE</a>:
<a name="l00308"></a>00308     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#a5443afbb6251a2a6f54cbf3c32e59f3dab0b7cb8e5bc15289f14e1ec4af02c065">DATA_SLOTNAME</a>:
<a name="l00309"></a>00309     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#a5443afbb6251a2a6f54cbf3c32e59f3dab8e56bace8e5b2a8c9566c634579f9a9">DATA_STRING</a>:
<a name="l00310"></a>00310       <span class="keywordflow">return</span> <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;%s&quot;</span>, string_cast(v).c_str());
<a name="l00311"></a>00311       <span class="keywordflow">break</span>;
<a name="l00312"></a>00312 
<a name="l00313"></a>00313     <span class="comment">// Use our own sendBinary for binary, who knows how to talk to k1 and k2.</span>
<a name="l00314"></a>00314     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#a5443afbb6251a2a6f54cbf3c32e59f3daf0b796de962926c04ce1c550d6f6b1cb">DATA_BINARY</a>:
<a name="l00315"></a>00315       <span class="keywordflow">if</span> (v.<a class="code" href="classurbi_1_1_u_value.html#a28623f06fd5371d8af67414b0bd938c5" title="value if of type DATA_BINARY">binary</a>-&gt;<a class="code" href="classurbi_1_1_u_binary.html#ab66cf9c9b8953eef7aba81eab8a4d104">type</a> != <a class="code" href="namespaceurbi.html#a245ce12ba6be6a6c613950505db2ea21abd966e1ed1b5a0aded1d985068593010">BINARY_NONE</a>
<a name="l00316"></a>00316           &amp;&amp; v.<a class="code" href="classurbi_1_1_u_value.html#a28623f06fd5371d8af67414b0bd938c5" title="value if of type DATA_BINARY">binary</a>-&gt;<a class="code" href="classurbi_1_1_u_binary.html#ab66cf9c9b8953eef7aba81eab8a4d104">type</a> != <a class="code" href="namespaceurbi.html#a245ce12ba6be6a6c613950505db2ea21a4b3d5b5462ca34fd9b1ff6762006be3c">BINARY_UNKNOWN</a>)
<a name="l00317"></a>00317         v.<a class="code" href="classurbi_1_1_u_value.html#a28623f06fd5371d8af67414b0bd938c5" title="value if of type DATA_BINARY">binary</a>-&gt;<a class="code" href="classurbi_1_1_u_binary.html#ac4acb791160f3c0e12dc5e86208432a6" title="Store the result of getMessage() in member message.">buildMessage</a>();
<a name="l00318"></a>00318       <span class="keywordflow">return</span> <a class="code" href="group___sending.html#gaf9f9e6ac1fcd615f4628f52ac7a6231c" title="Send an urbi Binary value.">sendBinary</a>(v.<a class="code" href="classurbi_1_1_u_value.html#a28623f06fd5371d8af67414b0bd938c5" title="value if of type DATA_BINARY">binary</a>-&gt;<a class="code" href="classurbi_1_1_u_binary.html#a38b72b4f01ee4589b49632a10ffb4108">common</a>.data, v.<a class="code" href="classurbi_1_1_u_value.html#a28623f06fd5371d8af67414b0bd938c5" title="value if of type DATA_BINARY">binary</a>-&gt;<a class="code" href="classurbi_1_1_u_binary.html#a38b72b4f01ee4589b49632a10ffb4108">common</a>.size,
<a name="l00319"></a>00319                         v.<a class="code" href="classurbi_1_1_u_value.html#a28623f06fd5371d8af67414b0bd938c5" title="value if of type DATA_BINARY">binary</a>-&gt;<a class="code" href="classurbi_1_1_u_binary.html#a029d1b5c514f258d03a436b5b85c0648" title="Headers (everything after &amp;quot;BIN theSize&amp;quot; and before &amp;#39;;&amp;#39; or  ).">message</a>);
<a name="l00320"></a>00320       <span class="keywordflow">break</span>;
<a name="l00321"></a>00321 
<a name="l00322"></a>00322     <span class="comment">// Lists can contain binary, so recurse using this function.</span>
<a name="l00323"></a>00323     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#a5443afbb6251a2a6f54cbf3c32e59f3dad7e7715f465fa7ad35e3d2ac98adbc38">DATA_LIST</a>:
<a name="l00324"></a>00324       <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;[&quot;</span>);
<a name="l00325"></a>00325       <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0, sz = v.<a class="code" href="classurbi_1_1_u_value.html#a072bcbb3009dd1ada961ed2b8ed92643" title="value if of type DATA_LIST">list</a>-&gt;<a class="code" href="classurbi_1_1_u_list.html#a4538b52c82e68afbc352507c9996ebea">size</a>();
<a name="l00326"></a>00326            i &lt; sz; ++i)
<a name="l00327"></a>00327       {
<a name="l00328"></a>00328         <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>((*v.<a class="code" href="classurbi_1_1_u_value.html#a072bcbb3009dd1ada961ed2b8ed92643" title="value if of type DATA_LIST">list</a>)[i]);
<a name="l00329"></a>00329         <span class="keywordflow">if</span> (i != sz-1)
<a name="l00330"></a>00330           <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot; , &quot;</span>);
<a name="l00331"></a>00331       }
<a name="l00332"></a>00332       <span class="keywordflow">return</span> <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;]&quot;</span>);
<a name="l00333"></a>00333       <span class="keywordflow">break</span>;
<a name="l00334"></a>00334 
<a name="l00335"></a>00335     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#a5443afbb6251a2a6f54cbf3c32e59f3daf64488d63db570aa5d26295322fbd1f9">DATA_DICTIONARY</a>:
<a name="l00336"></a>00336       <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;[&quot;</span>);
<a name="l00337"></a>00337       <span class="keywordflow">if</span> (v.<a class="code" href="classurbi_1_1_u_value.html#ab1d40f512478e880ba221e8bb2a11bae" title="value if of type DATA_DICTIONARY">dictionary</a>-&gt;empty())
<a name="l00338"></a>00338         <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;=&gt;&quot;</span>);
<a name="l00339"></a>00339       <span class="keywordflow">else</span>
<a name="l00340"></a>00340       {
<a name="l00341"></a>00341         <span class="keywordtype">bool</span> first = <span class="keyword">true</span>;
<a name="l00342"></a>00342         <span class="keywordflow">foreach</span> (<span class="keyword">const</span> UDictionary::value_type&amp; d, *v.<a class="code" href="classurbi_1_1_u_value.html#ab1d40f512478e880ba221e8bb2a11bae" title="value if of type DATA_DICTIONARY">dictionary</a>)
<a name="l00343"></a>00343         {
<a name="l00344"></a>00344           <span class="keywordflow">if</span> (!first)
<a name="l00345"></a>00345             <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;,&quot;</span>);
<a name="l00346"></a>00346           <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;\&quot;%s\&quot;=&gt;&quot;</span>, string_cast(libport::escape(d.first)).c_str());
<a name="l00347"></a>00347           <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(d.second);
<a name="l00348"></a>00348           first = <span class="keyword">false</span>;
<a name="l00349"></a>00349         }
<a name="l00350"></a>00350       }
<a name="l00351"></a>00351       <span class="keywordflow">return</span> <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;]&quot;</span>);
<a name="l00352"></a>00352       <span class="keywordflow">break</span>;
<a name="l00353"></a>00353 
<a name="l00354"></a>00354     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#a5443afbb6251a2a6f54cbf3c32e59f3da354fa28b07e9583a056342dc7f4ef3a0">DATA_OBJECT</a>:
<a name="l00355"></a>00355       <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;OBJ %s [&quot;</span>, v.<a class="code" href="classurbi_1_1_u_value.html#a19a81f3bef805ab8c2cff3eb51067682" title="value if of type DATA_OBJ">object</a>-&gt;<a class="code" href="classurbi_1_1_u_object_struct.html#ad5a6336eee79511941fe4911b7d818f6">refName</a>.c_str());
<a name="l00356"></a>00356       <span class="keywordflow">for</span> (<span class="keywordtype">size_t</span> i = 0, sz = v.<a class="code" href="classurbi_1_1_u_value.html#a19a81f3bef805ab8c2cff3eb51067682" title="value if of type DATA_OBJ">object</a>-&gt;<a class="code" href="classurbi_1_1_u_object_struct.html#a69c2184e19f762561f075c144047f27c">size</a>();
<a name="l00357"></a>00357            i &lt; sz; ++i)
<a name="l00358"></a>00358       {
<a name="l00359"></a>00359         <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;%s :&quot;</span>, (*v.<a class="code" href="classurbi_1_1_u_value.html#a19a81f3bef805ab8c2cff3eb51067682" title="value if of type DATA_OBJ">object</a>)[i].name.c_str());
<a name="l00360"></a>00360         <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(*((*v.<a class="code" href="classurbi_1_1_u_value.html#a19a81f3bef805ab8c2cff3eb51067682" title="value if of type DATA_OBJ">object</a>)[i].val) );
<a name="l00361"></a>00361         <span class="keywordflow">if</span> (i != sz-1)
<a name="l00362"></a>00362           <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot; , &quot;</span>);
<a name="l00363"></a>00363       }
<a name="l00364"></a>00364       <span class="keywordflow">return</span> <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;]&quot;</span>);
<a name="l00365"></a>00365       <span class="keywordflow">break</span>;
<a name="l00366"></a>00366 
<a name="l00367"></a>00367     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#a5443afbb6251a2a6f54cbf3c32e59f3da37930b63d7d14b2efdf1b6eb0e7514d9">DATA_VOID</a>:
<a name="l00368"></a>00368       <span class="keywordflow">break</span>;
<a name="l00369"></a>00369     };
<a name="l00370"></a>00370     <span class="keywordflow">return</span> 0;
<a name="l00371"></a>00371   }
<a name="l00372"></a>00372 
<a name="l00373"></a>00373   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00374"></a><a class="code" href="group___sending.html#gaa4d7135dc6f04657b83ce21b214b1597">00374</a>   <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">UAbstractClient::send</a>(std::istream&amp; is)
<a name="l00375"></a>00375   {
<a name="l00376"></a>00376     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>)
<a name="l00377"></a>00377       <span class="keywordflow">return</span> -1;
<a name="l00378"></a>00378     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.lock();
<a name="l00379"></a>00379     <span class="keywordflow">while</span> (is.good() &amp;&amp; !<a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>)
<a name="l00380"></a>00380     {
<a name="l00381"></a>00381       is.read(<a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>, <a class="code" href="classurbi_1_1_u_abstract_client.html#a44686898e996b40972ad9886f4339538" title="Buffer sizes.">sendBufSize</a>);
<a name="l00382"></a>00382       <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a> = <a class="code" href="classurbi_1_1_u_abstract_client.html#a5ebc9f1531123f579bd69083ed4a1cd2" title="Queue data for sending, returns zero on success, nonzero on failure.">effectiveSend</a>(<a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>, is.gcount());
<a name="l00383"></a>00383     }
<a name="l00384"></a>00384     <a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>[0] = 0;
<a name="l00385"></a>00385     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.unlock();
<a name="l00386"></a>00386     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>;
<a name="l00387"></a>00387   }
<a name="l00388"></a>00388 
<a name="l00389"></a>00389 
<a name="l00390"></a>00390 
<a name="l00395"></a>00395   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00396"></a><a class="code" href="group___sending.html#gafaa2633722e991e5a6a2c98b28e91092">00396</a>   <a class="code" href="group___sending.html#gafaa2633722e991e5a6a2c98b28e91092" title="Append Urbi commands to the send buffer (for backward compatibility, will be removed in future versio...">UAbstractClient::pack</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* command, ...)
<a name="l00397"></a>00397   {
<a name="l00398"></a>00398     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>)
<a name="l00399"></a>00399       <span class="keywordflow">return</span> -1;
<a name="l00400"></a>00400     va_list arg;
<a name="l00401"></a>00401     va_start(arg, command);
<a name="l00402"></a>00402     <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a> = <a class="code" href="group___sending.html#ga652b271e0db64307ce69c7468d7fcd08" title="va_list version of pack.">vpack</a>(command, arg);
<a name="l00403"></a>00403     va_end(arg);
<a name="l00404"></a>00404     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>;
<a name="l00405"></a>00405   }
<a name="l00406"></a>00406 
<a name="l00407"></a>00407 
<a name="l00408"></a>00408   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00409"></a><a class="code" href="group___sending.html#ga652b271e0db64307ce69c7468d7fcd08">00409</a>   <a class="code" href="group___sending.html#ga652b271e0db64307ce69c7468d7fcd08" title="va_list version of pack.">UAbstractClient::vpack</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* command, va_list arg)
<a name="l00410"></a>00410   {
<a name="l00411"></a>00411     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>)
<a name="l00412"></a>00412       <span class="keywordflow">return</span> -1;
<a name="l00413"></a>00413     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.lock();
<a name="l00414"></a>00414     <span class="keywordflow">if</span> (command)
<a name="l00415"></a>00415     {
<a name="l00416"></a>00416       <span class="comment">// Don&#39;t print if we overflow the buffer.  It would be nice to</span>
<a name="l00417"></a>00417       <span class="comment">// rely on the behavior of the GNU LibC which accepts 0 as</span>
<a name="l00418"></a>00418       <span class="comment">// destination buffer to query the space needed.  But it is not</span>
<a name="l00419"></a>00419       <span class="comment">// portable (e.g., segv on OS X).  So rather, try to vsnprintf,</span>
<a name="l00420"></a>00420       <span class="comment">// and upon failure, revert the buffer in its previous state.</span>
<a name="l00421"></a>00421       <span class="keywordtype">size_t</span> slen = strlen(<a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>);
<a name="l00422"></a>00422       <span class="keywordtype">size_t</span> msize = <a class="code" href="classurbi_1_1_u_abstract_client.html#a44686898e996b40972ad9886f4339538" title="Buffer sizes.">sendBufSize</a> - slen;
<a name="l00423"></a>00423       <span class="keywordtype">int</span> r = vsnprintf(<a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a> + slen, msize, command, arg);
<a name="l00424"></a>00424       <span class="comment">// vsprintf returns the number of characters to write.  Check</span>
<a name="l00425"></a>00425       <span class="comment">// that it fits.  Don&#39;t forget the ending &#39;\0&#39; that it does not</span>
<a name="l00426"></a>00426       <span class="comment">// count, but wants to add.</span>
<a name="l00427"></a>00427       <span class="keywordflow">if</span> (r &lt; 0 || static_cast&lt;int&gt;(msize) &lt;= r)
<a name="l00428"></a>00428       {
<a name="l00429"></a>00429         <span class="comment">// Don&#39;t produce partial input.</span>
<a name="l00430"></a>00430         <a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>[slen] = 0;
<a name="l00431"></a>00431         <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a> = -1;
<a name="l00432"></a>00432       }
<a name="l00433"></a>00433     }
<a name="l00434"></a>00434     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.unlock();
<a name="l00435"></a>00435     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>;
<a name="l00436"></a>00436   }
<a name="l00437"></a>00437 
<a name="l00438"></a>00438 
<a name="l00439"></a>00439   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00440"></a><a class="code" href="group___sending.html#ga039f921151de8ed7d078bc1175b907e8">00440</a>   <a class="code" href="group___sending.html#ga039f921151de8ed7d078bc1175b907e8" title="Send urbi commands contained in a file.">UAbstractClient::sendFile</a>(<span class="keyword">const</span> std::string&amp; f)
<a name="l00441"></a>00441   {
<a name="l00442"></a>00442     <span class="keywordflow">if</span> (f == <span class="stringliteral">&quot;/dev/stdin&quot;</span>)
<a name="l00443"></a>00443       <span class="keywordflow">return</span> <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(std::cin);
<a name="l00444"></a>00444     <span class="keywordflow">else</span>
<a name="l00445"></a>00445     {
<a name="l00446"></a>00446       std::ifstream is(f.c_str(), std::ios::binary);
<a name="l00447"></a>00447       <span class="keywordflow">if</span> (is.fail())
<a name="l00448"></a>00448         <span class="keywordflow">return</span> -1;
<a name="l00449"></a>00449       <span class="keywordflow">else</span>
<a name="l00450"></a>00450         <span class="keywordflow">return</span> <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(is);
<a name="l00451"></a>00451     }
<a name="l00452"></a>00452   }
<a name="l00453"></a>00453 
<a name="l00454"></a>00454 
<a name="l00455"></a>00455   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00456"></a><a class="code" href="group___sending.html#gab320917c135debc6620a6706d1b3db97">00456</a>   <a class="code" href="group___sending.html#gab320917c135debc6620a6706d1b3db97" title="Send binary data.">UAbstractClient::sendBin</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len)
<a name="l00457"></a>00457   {
<a name="l00458"></a>00458     <span class="keywordflow">return</span> <a class="code" href="group___sending.html#gab320917c135debc6620a6706d1b3db97" title="Send binary data.">sendBin</a>(buffer, len, 0);
<a name="l00459"></a>00459   }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461 
<a name="l00462"></a>00462   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00463"></a><a class="code" href="group___sending.html#gaf272f70217c3a7fc233239d36689390c">00463</a>   <a class="code" href="group___sending.html#gab320917c135debc6620a6706d1b3db97" title="Send binary data.">UAbstractClient::sendBin</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> len,
<a name="l00464"></a>00464                            <span class="keyword">const</span> <span class="keywordtype">char</span>* header, ...)
<a name="l00465"></a>00465   {
<a name="l00466"></a>00466     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>)
<a name="l00467"></a>00467       <span class="keywordflow">return</span> -1;
<a name="l00468"></a>00468     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.lock();
<a name="l00469"></a>00469     <span class="keywordflow">if</span> (header)
<a name="l00470"></a>00470     {
<a name="l00471"></a>00471       va_list arg;
<a name="l00472"></a>00472       va_start(arg, header);
<a name="l00473"></a>00473       <a class="code" href="group___sending.html#ga652b271e0db64307ce69c7468d7fcd08" title="va_list version of pack.">vpack</a>(header, arg);
<a name="l00474"></a>00474       va_end(arg);
<a name="l00475"></a>00475       <a class="code" href="classurbi_1_1_u_abstract_client.html#a4fe351ee52f67775fbf03bc4d1d6dd14" title="Bounce to effectiveSend() using strlen.">effective_send</a>(<a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>);
<a name="l00476"></a>00476     }
<a name="l00477"></a>00477 
<a name="l00478"></a>00478     <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">error_type</a> res = <a class="code" href="classurbi_1_1_u_abstract_client.html#a5ebc9f1531123f579bd69083ed4a1cd2" title="Queue data for sending, returns zero on success, nonzero on failure.">effectiveSend</a>(buffer, len);
<a name="l00479"></a>00479     <a class="code" href="classurbi_1_1_u_abstract_client.html#af2802aaacdfeb0b4905dba20942dda33" title="Temporary buffer for send data.">sendBuffer</a>[0] = 0;
<a name="l00480"></a>00480     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.unlock();
<a name="l00481"></a>00481     <span class="keywordflow">return</span> res;
<a name="l00482"></a>00482   }
<a name="l00483"></a>00483 
<a name="l00484"></a>00484   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00485"></a><a class="code" href="group___sending.html#gaf9f9e6ac1fcd615f4628f52ac7a6231c">00485</a>   <a class="code" href="group___sending.html#gaf9f9e6ac1fcd615f4628f52ac7a6231c" title="Send an urbi Binary value.">UAbstractClient::sendBinary</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* data, <span class="keywordtype">size_t</span> len,
<a name="l00486"></a>00486                               <span class="keyword">const</span> std::string&amp; header)
<a name="l00487"></a>00487   {
<a name="l00488"></a>00488     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a2847dd0360913229b9d15239be848e3a" title="Major kernel version. Dies if unknown yet.">kernelMajor</a>() &lt; 2)
<a name="l00489"></a>00489       <span class="keywordflow">return</span> <a class="code" href="group___sending.html#gab320917c135debc6620a6706d1b3db97" title="Send binary data.">sendBin</a>(data, len, <span class="stringliteral">&quot;BIN %lu %s;&quot;</span>,
<a name="l00490"></a>00490                      static_cast&lt;unsigned long&gt;(len), header.c_str());
<a name="l00491"></a>00491     <span class="keywordflow">else</span>
<a name="l00492"></a>00492     {
<a name="l00493"></a>00493       <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.lock();
<a name="l00494"></a>00494       *<span class="keyword">this</span> &lt;&lt; libport::format(<span class="stringliteral">&quot;Global.Binary.new(\&quot;%s\&quot;, \&quot;\\B(%s)(&quot;</span>,
<a name="l00495"></a>00495                                libport::escape(header), len);
<a name="l00496"></a>00496       <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(0);
<a name="l00497"></a>00497       <a class="code" href="classurbi_1_1_u_abstract_client.html#a5ebc9f1531123f579bd69083ed4a1cd2" title="Queue data for sending, returns zero on success, nonzero on failure.">effectiveSend</a>(data, len);
<a name="l00498"></a>00498       *<span class="keyword">this</span> &lt;&lt; <span class="stringliteral">&quot;)\&quot;)&quot;</span>;
<a name="l00499"></a>00499       <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(0);
<a name="l00500"></a>00500       <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.unlock();
<a name="l00501"></a>00501       <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#a785d7c4a9d83f35cf3dc426321f0955a" title="System calls return value storage.">rc</a>;
<a name="l00502"></a>00502     }
<a name="l00503"></a>00503   }
<a name="l00504"></a>00504 
<a name="l00505"></a>00505   <span class="keyword">struct </span>sendSoundData
<a name="l00506"></a>00506   {
<a name="l00507"></a>00507     <span class="keywordtype">char</span>* buffer;
<a name="l00508"></a>00508     <span class="keywordtype">int</span> bytespersec;
<a name="l00509"></a>00509     <span class="keywordtype">size_t</span> length;
<a name="l00510"></a>00510     <span class="keywordtype">size_t</span> pos;
<a name="l00511"></a>00511     <span class="keywordtype">char</span>* device;
<a name="l00512"></a>00512     <span class="keywordtype">char</span>* tag;
<a name="l00513"></a>00513     <span class="keywordtype">char</span> formatString[50];
<a name="l00514"></a>00514     <a class="code" href="namespaceurbi.html#ab2964d3c10cb138516f7cec513772b29">USoundFormat</a> format;
<a name="l00515"></a>00515     <a class="code" href="classurbi_1_1_u_abstract_client.html" title="Interface for an URBI wrapper object.">UAbstractClient</a>* uc;
<a name="l00516"></a>00516     <span class="keywordtype">bool</span> startNotify;
<a name="l00517"></a>00517   };
<a name="l00518"></a>00518 
<a name="l00519"></a><a class="code" href="namespaceurbi.html#a4b0fe870f0b3b9cf1b76b75b35354c64">00519</a>   <span class="keyword">static</span> <a class="code" href="namespaceurbi.html#a63f30f52002e7e7f853a12a8c1172f41" title="Return values for the callcack functions.">UCallbackAction</a> <a class="code" href="namespaceurbi.html#a4b0fe870f0b3b9cf1b76b75b35354c64">sendSound_</a>(<span class="keywordtype">void</span>* cb, <span class="keyword">const</span> <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a> &amp;msg)
<a name="l00520"></a>00520   {
<a name="l00521"></a>00521     <span class="comment">//the idea is to cut the sound into small chunks,</span>
<a name="l00522"></a>00522     <span class="comment">//add a header and send each chunk separately</span>
<a name="l00523"></a>00523 
<a name="l00524"></a>00524     <span class="comment">//create the header.</span>
<a name="l00525"></a>00525     <span class="keyword">static</span> <span class="keyword">const</span> <span class="keywordtype">size_t</span> CHUNK_SIZE = 32 * 8*60;
<a name="l00526"></a>00526     sendSoundData* s = (sendSoundData*)cb;
<a name="l00527"></a>00527     <span class="comment">//handle next chunk</span>
<a name="l00528"></a>00528     <span class="keywordflow">if</span> (s-&gt;format == <a class="code" href="namespaceurbi.html#ab2964d3c10cb138516f7cec513772b29ad35e89822a7d2e45990809926edb6789">SOUND_WAV</a> &amp;&amp; s-&gt;pos==0)
<a name="l00529"></a>00529       s-&gt;pos = <span class="keyword">sizeof</span> (<a class="code" href="structurbi_1_1wavheader.html">wavheader</a>);
<a name="l00530"></a>00530     <span class="keywordtype">size_t</span> tosend = std::min(CHUNK_SIZE, s-&gt;length - s-&gt;pos);
<a name="l00531"></a>00531 
<a name="l00532"></a>00532     <span class="comment">//int playlength = tosend *1000 / s-&gt;bytespersec;</span>
<a name="l00533"></a>00533     std::string header = ((s-&gt;format == SOUND_WAV) ? <span class="stringliteral">&quot;wav &quot;</span> : <span class="stringliteral">&quot;raw &quot;</span>)
<a name="l00534"></a>00534       + (std::string)s-&gt;formatString;
<a name="l00535"></a>00535 
<a name="l00536"></a>00536     s-&gt;uc-&gt;send(<span class="stringliteral">&quot;%s.val = Global.Binary.new(\&quot;%s\&quot;, \&quot;\\B(%lu)(&quot;</span>,
<a name="l00537"></a>00537                 s-&gt;device,
<a name="l00538"></a>00538                 header.c_str(),
<a name="l00539"></a>00539                 <span class="keyword">static_cast&lt;</span><span class="keywordtype">unsigned</span> <span class="keywordtype">long</span><span class="keyword">&gt;</span>
<a name="l00540"></a>00540                 (tosend + ((s-&gt;format == SOUND_WAV) ? <span class="keyword">sizeof</span> (<a class="code" href="structurbi_1_1wavheader.html">wavheader</a>) : 0))
<a name="l00541"></a>00541                 );
<a name="l00542"></a>00542 
<a name="l00543"></a>00543     <span class="keywordflow">if</span> (s-&gt;format == <a class="code" href="namespaceurbi.html#ab2964d3c10cb138516f7cec513772b29ad35e89822a7d2e45990809926edb6789">SOUND_WAV</a>)
<a name="l00544"></a>00544     {
<a name="l00545"></a>00545       <a class="code" href="structurbi_1_1wavheader.html">wavheader</a> wh;
<a name="l00546"></a>00546       memcpy(&amp;wh, s-&gt;buffer, <span class="keyword">sizeof</span> wh);
<a name="l00547"></a>00547       wh.<a class="code" href="structurbi_1_1wavheader.html#af976957082dbbbbcb51450b1b16b2257">datalength</a>=tosend;
<a name="l00548"></a>00548       wh.<a class="code" href="structurbi_1_1wavheader.html#a48c7fc0b15f881537fd1098b579d1804">length</a>=tosend+44-8;
<a name="l00549"></a>00549       s-&gt;uc-&gt;sendBin(&amp;wh, <span class="keyword">sizeof</span> wh);
<a name="l00550"></a>00550     }
<a name="l00551"></a>00551     s-&gt;uc-&gt;sendBin(s-&gt;buffer+s-&gt;pos, tosend);
<a name="l00553"></a>00553     s-&gt;uc-&gt;send(<span class="stringliteral">&quot;)\&quot;)|;waituntil(%s.remain &lt; 1000);\n&quot;</span>
<a name="l00554"></a>00554                 <span class="stringliteral">&quot; %s &lt;&lt; 1;\n&quot;</span>, s-&gt;device, msg.<a class="code" href="classurbi_1_1_u_message.html#a663f67700bf8eaa3fcb859e018466403" title="Associated tag.">tag</a>.c_str());
<a name="l00555"></a>00555     s-&gt;pos += tosend;
<a name="l00556"></a>00556     <span class="keywordflow">if</span> (s-&gt;pos &gt;= s-&gt;length)
<a name="l00557"></a>00557     {
<a name="l00558"></a>00558       <span class="keyword">const</span> <span class="keywordtype">char</span>* dev = s-&gt;device ? s-&gt;device : <span class="stringliteral">&quot;speaker&quot;</span>;
<a name="l00559"></a>00559       s-&gt;uc-&gt;send(<span class="stringliteral">&quot;%s.val-&gt;blend = %s.sendsoundsaveblend;&quot;</span>, dev, dev);
<a name="l00560"></a>00560 
<a name="l00561"></a>00561       <span class="keywordflow">if</span> (s-&gt;tag &amp;&amp; s-&gt;tag[0])
<a name="l00562"></a>00562         s-&gt;uc-&gt;send(<span class="stringliteral">&quot;Channel.new(\&quot;%s\&quot;) &lt;&lt; 1;\n&quot;</span>, s-&gt;tag);
<a name="l00563"></a>00563       <span class="keyword">delete</span>[] s-&gt;buffer;
<a name="l00564"></a>00564       free(s-&gt;tag);
<a name="l00565"></a>00565       free(s-&gt;device);
<a name="l00566"></a>00566       <span class="keyword">delete</span> s;
<a name="l00567"></a>00567       <span class="keywordflow">return</span> URBI_REMOVE;
<a name="l00568"></a>00568     }
<a name="l00569"></a>00569     <span class="keywordflow">return</span> URBI_CONTINUE;
<a name="l00570"></a>00570   }
<a name="l00571"></a>00571 
<a name="l00578"></a>00578   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00579"></a><a class="code" href="group___sending.html#ga0273be9400bbddc4a09d00cb0b57f5f3">00579</a>   <a class="code" href="group___sending.html#ga0273be9400bbddc4a09d00cb0b57f5f3" title="Send sound data to the robot for immediate playback.">UAbstractClient::sendSound</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* device, <span class="keyword">const</span> <a class="code" href="classurbi_1_1_u_sound.html" title="Class encapsulating sound information.">USound</a>&amp; sound,
<a name="l00580"></a>00580                              <span class="keyword">const</span> <span class="keywordtype">char</span>* tag)
<a name="l00581"></a>00581   {
<a name="l00582"></a>00582     <span class="keywordflow">switch</span> (sound.<a class="code" href="classurbi_1_1_u_sound.html#ab55804c1d5c956e18c48599aa2c7e4e1" title="Format of the sound data.">soundFormat</a>)
<a name="l00583"></a>00583     {
<a name="l00584"></a>00584     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#ab2964d3c10cb138516f7cec513772b29a6993e75e6ad1e3b76460af204deb75bd">SOUND_MP3</a>:
<a name="l00585"></a>00585     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#ab2964d3c10cb138516f7cec513772b29a0e03994fb762e426b8e7824fa8597887">SOUND_OGG</a>:
<a name="l00586"></a>00586       <span class="comment">// We don&#39;t handle chunking for these formats.</span>
<a name="l00587"></a>00587       <span class="keywordflow">return</span> <a class="code" href="group___sending.html#gab320917c135debc6620a6706d1b3db97" title="Send binary data.">sendBin</a>(sound.<a class="code" href="classurbi_1_1_u_sound.html#aa8fc8d5b17cd9228f242bbdbb13b0611" title="Pointer to sound data.">data</a>, sound.<a class="code" href="classurbi_1_1_u_sound.html#ae0467ed118dd1977bfc506e72c2c6ced" title="Total size in byte.">size</a>,
<a name="l00588"></a>00588                      <span class="stringliteral">&quot;%s +report:  %s.val = BIN %lu %s;&quot;</span>,
<a name="l00589"></a>00589                      tag, device, static_cast&lt;unsigned long&gt;(sound.<a class="code" href="classurbi_1_1_u_sound.html#ae0467ed118dd1977bfc506e72c2c6ced" title="Total size in byte.">size</a>),
<a name="l00590"></a>00590                      sound.<a class="code" href="classurbi_1_1_u_sound.html#ab55804c1d5c956e18c48599aa2c7e4e1" title="Format of the sound data.">soundFormat</a> == <a class="code" href="namespaceurbi.html#ab2964d3c10cb138516f7cec513772b29a6993e75e6ad1e3b76460af204deb75bd">SOUND_MP3</a> ? <span class="stringliteral">&quot;mp3&quot;</span> : <span class="stringliteral">&quot;ogg&quot;</span>);
<a name="l00591"></a>00591       <span class="keywordflow">break</span>;
<a name="l00592"></a>00592 
<a name="l00593"></a>00593     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#ab2964d3c10cb138516f7cec513772b29ad35e89822a7d2e45990809926edb6789">SOUND_WAV</a>:
<a name="l00594"></a>00594     <span class="keywordflow">case</span> <a class="code" href="namespaceurbi.html#ab2964d3c10cb138516f7cec513772b29aa40daf6b55ffb537b5700a0d064967f3">SOUND_RAW</a>:
<a name="l00595"></a>00595     {
<a name="l00596"></a>00596       <span class="keyword">const</span> <span class="keywordtype">char</span>* dev = device ? device : <span class="stringliteral">&quot;speaker&quot;</span>;
<a name="l00597"></a>00597       <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;%s.removeSlot(\&quot;sendsoundsaveblend\&quot;) | var %s.sendsoundsaveblend = %s.val-&gt;blend; %s.val-&gt;blend=\&quot;queue\&quot;;&quot;</span>,
<a name="l00598"></a>00598            dev, dev, dev, dev);
<a name="l00599"></a>00599       sendSoundData* s = <span class="keyword">new</span> sendSoundData();
<a name="l00600"></a>00600       s-&gt;bytespersec = sound.<a class="code" href="classurbi_1_1_u_sound.html#aedd2b9816f250857613da7ca8a70e2cf" title="Number of audio channels.">channels</a> * sound.<a class="code" href="classurbi_1_1_u_sound.html#a95501819b0a2e73f3118c0f699a2e33b" title="Rate in Hertz.">rate</a> * (sound.<a class="code" href="classurbi_1_1_u_sound.html#a29a569c0e11f0f8cdaaf864fc867ccb2" title="Sample size in bit.">sampleSize</a> / 8);
<a name="l00601"></a>00601       s-&gt;uc = <span class="keyword">this</span>;
<a name="l00602"></a>00602       s-&gt;buffer = <span class="keyword">new</span> <span class="keywordtype">char</span>[sound.<a class="code" href="classurbi_1_1_u_sound.html#ae0467ed118dd1977bfc506e72c2c6ced" title="Total size in byte.">size</a>];
<a name="l00603"></a>00603       memcpy(s-&gt;buffer, sound.<a class="code" href="classurbi_1_1_u_sound.html#aa8fc8d5b17cd9228f242bbdbb13b0611" title="Pointer to sound data.">data</a>, sound.<a class="code" href="classurbi_1_1_u_sound.html#ae0467ed118dd1977bfc506e72c2c6ced" title="Total size in byte.">size</a>);
<a name="l00604"></a>00604       s-&gt;length = sound.<a class="code" href="classurbi_1_1_u_sound.html#ae0467ed118dd1977bfc506e72c2c6ced" title="Total size in byte.">size</a>;
<a name="l00605"></a>00605       s-&gt;tag = tag ? strdup(tag) : 0;
<a name="l00606"></a>00606       s-&gt;device = strdup(device);
<a name="l00607"></a>00607       s-&gt;pos = 0;
<a name="l00608"></a>00608       s-&gt;format = sound.<a class="code" href="classurbi_1_1_u_sound.html#ab55804c1d5c956e18c48599aa2c7e4e1" title="Format of the sound data.">soundFormat</a>;
<a name="l00609"></a>00609       <span class="keywordflow">if</span> (sound.<a class="code" href="classurbi_1_1_u_sound.html#ab55804c1d5c956e18c48599aa2c7e4e1" title="Format of the sound data.">soundFormat</a> == <a class="code" href="namespaceurbi.html#ab2964d3c10cb138516f7cec513772b29aa40daf6b55ffb537b5700a0d064967f3">SOUND_RAW</a>)
<a name="l00610"></a>00610         sprintf(s-&gt;formatString, <span class="stringliteral">&quot;%zd %zd %zd %d&quot;</span>,
<a name="l00611"></a>00611                 sound.<a class="code" href="classurbi_1_1_u_sound.html#aedd2b9816f250857613da7ca8a70e2cf" title="Number of audio channels.">channels</a>, sound.<a class="code" href="classurbi_1_1_u_sound.html#a95501819b0a2e73f3118c0f699a2e33b" title="Rate in Hertz.">rate</a>, sound.<a class="code" href="classurbi_1_1_u_sound.html#a29a569c0e11f0f8cdaaf864fc867ccb2" title="Sample size in bit.">sampleSize</a>,
<a name="l00612"></a>00612                 sound.<a class="code" href="classurbi_1_1_u_sound.html#a95b6f3b0be37142ffec3e4c4656eb780" title="Sample format.">sampleFormat</a>);
<a name="l00613"></a>00613       <span class="keywordflow">else</span>
<a name="l00614"></a>00614         s-&gt;formatString[0] = 0;
<a name="l00615"></a>00615       s-&gt;startNotify = <span class="keyword">false</span>;
<a name="l00616"></a>00616       std::string utag = <a class="code" href="classurbi_1_1_u_abstract_client.html#a6f075608171433ec592bf603f1d7d768" title="Return a identifier, for tags for instance.">fresh</a>();
<a name="l00617"></a>00617       (*this) &lt;&lt; <span class="stringliteral">&quot;var &quot;</span> + utag +<span class="stringliteral">&quot; = Channel.new(\&quot;&quot;</span> &lt;&lt; utag &lt;&lt; <span class="stringliteral">&quot;\&quot;);&quot;</span>;
<a name="l00618"></a>00618       <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a> cid = <a class="code" href="classurbi_1_1_u_abstract_client.html#a574c8f649ce663ebc5cd8211a01367aa" title="Associate a callback function with a tag. New style.">setCallback</a>(<a class="code" href="namespaceurbi.html#a4b0fe870f0b3b9cf1b76b75b35354c64">sendSound_</a>, s, utag.c_str());
<a name="l00619"></a>00619       <span class="comment">// Invoke it 2 times to queue sound.</span>
<a name="l00620"></a>00620       <span class="keywordflow">if</span> (<a class="code" href="namespaceurbi.html#a4b0fe870f0b3b9cf1b76b75b35354c64">sendSound_</a>(s, <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a>(*<span class="keyword">this</span>, 0, utag.c_str(), <span class="stringliteral">&quot;*** stop&quot;</span>,
<a name="l00621"></a>00621                                  <a class="code" href="namespaceurbi.html#a28dbd07b21d724058b728eb09fe5c77f" title="List of the binaries.">binaries_type</a>()))
<a name="l00622"></a>00622           == URBI_CONTINUE)
<a name="l00623"></a>00623       {
<a name="l00624"></a>00624         <span class="keywordflow">if</span> (<a class="code" href="namespaceurbi.html#a4b0fe870f0b3b9cf1b76b75b35354c64">sendSound_</a>(s, <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a>(*<span class="keyword">this</span>, 0, utag.c_str(), <span class="stringliteral">&quot;*** stop&quot;</span>,
<a name="l00625"></a>00625                                    <a class="code" href="namespaceurbi.html#a28dbd07b21d724058b728eb09fe5c77f" title="List of the binaries.">binaries_type</a>()))
<a name="l00626"></a>00626             == URBI_REMOVE)
<a name="l00627"></a>00627           <a class="code" href="classurbi_1_1_u_abstract_client.html#ad7f4fd4465b6930c76b64ed4c3eefb98" title="Delete a callback.">deleteCallback</a>(cid);
<a name="l00628"></a>00628       }
<a name="l00629"></a>00629       <span class="keywordflow">else</span>
<a name="l00630"></a>00630         <a class="code" href="classurbi_1_1_u_abstract_client.html#ad7f4fd4465b6930c76b64ed4c3eefb98" title="Delete a callback.">deleteCallback</a>(cid);
<a name="l00631"></a>00631       <span class="keywordflow">return</span> 0;
<a name="l00632"></a>00632     }
<a name="l00633"></a>00633 
<a name="l00634"></a>00634     <span class="keywordflow">default</span>:
<a name="l00635"></a>00635       <span class="comment">// Unrecognized format.</span>
<a name="l00636"></a>00636       <span class="keywordflow">return</span> 1;
<a name="l00637"></a>00637     }
<a name="l00638"></a>00638   }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640   <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a>
<a name="l00641"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#aa36712cc8cb7d83a8bbca1d5f97b64de">00641</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a574c8f649ce663ebc5cd8211a01367aa" title="Associate a callback function with a tag. New style.">UAbstractClient::setCallback</a>(<a class="code" href="namespaceurbi.html#a930fe72c26550eea59562f9ee4fbeea3" title="Callback prototypes.">UCallback</a> cb, <span class="keyword">const</span> <span class="keywordtype">char</span>* tag)
<a name="l00642"></a>00642   {
<a name="l00643"></a>00643     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#ab69addc60209eb96cbfe25b99ff22812" title="Add a callback to the list.">addCallback</a>(tag, *<span class="keyword">new</span> UCallbackWrapperCB(cb));
<a name="l00644"></a>00644   }
<a name="l00645"></a>00645 
<a name="l00646"></a>00646   <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a>
<a name="l00647"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#ad31efc16aca30f970103d2cf0708e393">00647</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a574c8f649ce663ebc5cd8211a01367aa" title="Associate a callback function with a tag. New style.">UAbstractClient::setCallback</a>(<a class="code" href="namespaceurbi.html#a7faaf004fc749ed1033937949137424b">UCustomCallback</a> cb,
<a name="l00648"></a>00648                                <span class="keywordtype">void</span>* cbData,
<a name="l00649"></a>00649                                <span class="keyword">const</span> <span class="keywordtype">char</span>* tag)
<a name="l00650"></a>00650   {
<a name="l00651"></a>00651     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#ab69addc60209eb96cbfe25b99ff22812" title="Add a callback to the list.">addCallback</a>(tag, *<span class="keyword">new</span> UCallbackWrapperCCB(cb, cbData));
<a name="l00652"></a>00652   }
<a name="l00653"></a>00653 
<a name="l00654"></a>00654 
<a name="l00655"></a>00655   <span class="keywordtype">int</span>
<a name="l00656"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a3e664ad4202070ffaed1f4bc047c95dc">00656</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a3e664ad4202070ffaed1f4bc047c95dc" title="Get the tag associated with a registered callback.">UAbstractClient::getAssociatedTag</a>(<a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a> <span class="keywordtype">id</span>, <span class="keywordtype">char</span>* tag)
<a name="l00657"></a>00657   {
<a name="l00658"></a>00658     <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.lock();
<a name="l00659"></a>00659     callbacks_type::iterator it =
<a name="l00660"></a>00660       std::find(<a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.begin(), <a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.end(), id);
<a name="l00661"></a>00661     <span class="keywordflow">if</span> (it == <a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.end())
<a name="l00662"></a>00662     {
<a name="l00663"></a>00663       <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.unlock();
<a name="l00664"></a>00664       <span class="keywordflow">return</span> 0;
<a name="l00665"></a>00665     }
<a name="l00666"></a>00666     strcpy(tag, it-&gt;tag);
<a name="l00667"></a>00667     <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.unlock();
<a name="l00668"></a>00668     <span class="keywordflow">return</span> 1;
<a name="l00669"></a>00669   }
<a name="l00670"></a>00670 
<a name="l00671"></a>00671 
<a name="l00672"></a>00672   <span class="keywordtype">int</span>
<a name="l00673"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#ad7f4fd4465b6930c76b64ed4c3eefb98">00673</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#ad7f4fd4465b6930c76b64ed4c3eefb98" title="Delete a callback.">UAbstractClient::deleteCallback</a>(<a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a> <span class="keywordtype">id</span>)
<a name="l00674"></a>00674   {
<a name="l00675"></a>00675     <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.lock();
<a name="l00676"></a>00676     callbacks_type::iterator it =
<a name="l00677"></a>00677       std::find(<a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.begin(), <a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.end(), id);
<a name="l00678"></a>00678     <span class="keywordflow">if</span> (it == <a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.end())
<a name="l00679"></a>00679     {
<a name="l00680"></a>00680       <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.unlock();
<a name="l00681"></a>00681       <span class="keywordflow">return</span> 0;
<a name="l00682"></a>00682     }
<a name="l00683"></a>00683     <span class="keyword">delete</span> &amp;(it-&gt;callback);
<a name="l00684"></a>00684     <a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.erase(it);
<a name="l00685"></a>00685     <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.unlock();
<a name="l00686"></a>00686     <span class="keywordflow">return</span> 1;
<a name="l00687"></a>00687   }
<a name="l00688"></a>00688 
<a name="l00689"></a>00689   <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a>
<a name="l00690"></a><a class="code" href="group___sending.html#ga275f213673019c05245913ff2207d508">00690</a>   <a class="code" href="group___sending.html#ga275f213673019c05245913ff2207d508" title="Send a command, prefixing it with a tag, and associate the given callback with this tag...">UAbstractClient::sendCommand</a>(<a class="code" href="namespaceurbi.html#a930fe72c26550eea59562f9ee4fbeea3" title="Callback prototypes.">UCallback</a> cb, <span class="keyword">const</span> <span class="keywordtype">char</span>* cmd, ...)
<a name="l00691"></a>00691   {
<a name="l00692"></a>00692     std::string tag = <a class="code" href="classurbi_1_1_u_abstract_client.html#a6f075608171433ec592bf603f1d7d768" title="Return a identifier, for tags for instance.">fresh</a>();
<a name="l00693"></a>00693     std::string mcmd = tag + <span class="stringliteral">&quot; &lt;&lt; &quot;</span> + cmd;
<a name="l00694"></a>00694     <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a> res = <a class="code" href="classurbi_1_1_u_abstract_client.html#a574c8f649ce663ebc5cd8211a01367aa" title="Associate a callback function with a tag. New style.">setCallback</a>(cb, tag.c_str());
<a name="l00695"></a>00695     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.lock();
<a name="l00696"></a>00696     va_list arg;
<a name="l00697"></a>00697     va_start(arg, cmd);
<a name="l00698"></a>00698     <a class="code" href="group___sending.html#ga652b271e0db64307ce69c7468d7fcd08" title="va_list version of pack.">vpack</a>(mcmd.c_str(), arg);
<a name="l00699"></a>00699     va_end(arg);
<a name="l00700"></a>00700     <span class="keywordflow">if</span> (<a class="code" href="group___sending.html#ga9e161015bcbdd77d6722e2c7ead18871" title="Unlock the send buffer (for backward compatibility, will be removed in future versions).">endPack</a>())
<a name="l00701"></a>00701     {
<a name="l00702"></a>00702       <a class="code" href="classurbi_1_1_u_abstract_client.html#ad7f4fd4465b6930c76b64ed4c3eefb98" title="Delete a callback.">deleteCallback</a>(res);
<a name="l00703"></a>00703       <span class="keywordflow">return</span> UINVALIDCALLBACKID;
<a name="l00704"></a>00704     }
<a name="l00705"></a>00705     <span class="keywordflow">return</span> res;
<a name="l00706"></a>00706   }
<a name="l00707"></a>00707 
<a name="l00708"></a>00708   <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a>
<a name="l00709"></a><a class="code" href="group___sending.html#ga344983d81730f44ba82a500444452076">00709</a>   <a class="code" href="group___sending.html#ga275f213673019c05245913ff2207d508" title="Send a command, prefixing it with a tag, and associate the given callback with this tag...">UAbstractClient::sendCommand</a>(<a class="code" href="namespaceurbi.html#a7faaf004fc749ed1033937949137424b">UCustomCallback</a> cb, <span class="keywordtype">void</span> *cbData,
<a name="l00710"></a>00710                                <span class="keyword">const</span> <span class="keywordtype">char</span>* cmd, ...)
<a name="l00711"></a>00711   {
<a name="l00712"></a>00712     std::string tag = <a class="code" href="classurbi_1_1_u_abstract_client.html#a6f075608171433ec592bf603f1d7d768" title="Return a identifier, for tags for instance.">fresh</a>();
<a name="l00713"></a>00713     std::string mcmd = tag + <span class="stringliteral">&quot; &lt;&lt; &quot;</span> + cmd;
<a name="l00714"></a>00714     <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a> res = <a class="code" href="classurbi_1_1_u_abstract_client.html#a574c8f649ce663ebc5cd8211a01367aa" title="Associate a callback function with a tag. New style.">setCallback</a>(cb, cbData, tag.c_str());
<a name="l00715"></a>00715     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.lock();
<a name="l00716"></a>00716     va_list arg;
<a name="l00717"></a>00717     va_start(arg, cmd);
<a name="l00718"></a>00718     <a class="code" href="group___sending.html#ga652b271e0db64307ce69c7468d7fcd08" title="va_list version of pack.">vpack</a>(mcmd.c_str(), arg);
<a name="l00719"></a>00719     va_end(arg);
<a name="l00720"></a>00720     <span class="keywordflow">if</span> (<a class="code" href="group___sending.html#ga9e161015bcbdd77d6722e2c7ead18871" title="Unlock the send buffer (for backward compatibility, will be removed in future versions).">endPack</a>())
<a name="l00721"></a>00721     {
<a name="l00722"></a>00722       <a class="code" href="classurbi_1_1_u_abstract_client.html#ad7f4fd4465b6930c76b64ed4c3eefb98" title="Delete a callback.">deleteCallback</a>(res);
<a name="l00723"></a>00723       <span class="keywordflow">return</span> UINVALIDCALLBACKID;
<a name="l00724"></a>00724     }
<a name="l00725"></a>00725     <span class="keywordflow">return</span> res;
<a name="l00726"></a>00726   }
<a name="l00727"></a>00727 
<a name="l00728"></a>00728   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00729"></a><a class="code" href="group___sending.html#gaea87052d1de140ca4b62ee94f2d2f690">00729</a>   <a class="code" href="group___sending.html#gaea87052d1de140ca4b62ee94f2d2f690" title="Put a file on the robot&amp;#39;s mass storage device.">UAbstractClient::putFile</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* localName, <span class="keyword">const</span> <span class="keywordtype">char</span>* remoteName)
<a name="l00730"></a>00730   {
<a name="l00731"></a>00731     <span class="keywordtype">size_t</span> len;
<a name="l00732"></a>00732     <span class="keyword">struct </span>stat st;
<a name="l00733"></a>00733     <span class="keywordflow">if</span> (stat(localName, &amp;st) == -1)
<a name="l00734"></a>00734       <span class="keywordflow">return</span> 1;
<a name="l00735"></a>00735     len = st.st_size;
<a name="l00736"></a>00736     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.lock();
<a name="l00737"></a>00737     <span class="keywordflow">if</span> (!remoteName)
<a name="l00738"></a>00738       remoteName = localName;
<a name="l00739"></a>00739     <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;save(\&quot;%s\&quot;, \&quot;&quot;</span>, remoteName);
<a name="l00740"></a>00740     <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">error_type</a> res = <a class="code" href="group___sending.html#ga039f921151de8ed7d078bc1175b907e8" title="Send urbi commands contained in a file.">sendFile</a>(localName);
<a name="l00741"></a>00741     <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;\&quot;);&quot;</span>);
<a name="l00742"></a>00742     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.unlock();
<a name="l00743"></a>00743     <span class="keywordflow">return</span> res;
<a name="l00744"></a>00744   }
<a name="l00745"></a>00745 
<a name="l00746"></a>00746   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l00747"></a><a class="code" href="group___sending.html#gaaa25d220f24ca17bbfa1cb7d3fcfc7d8">00747</a>   <a class="code" href="group___sending.html#gaea87052d1de140ca4b62ee94f2d2f690" title="Put a file on the robot&amp;#39;s mass storage device.">UAbstractClient::putFile</a>(<span class="keyword">const</span> <span class="keywordtype">void</span>* buffer, <span class="keywordtype">size_t</span> length,
<a name="l00748"></a>00748                            <span class="keyword">const</span> <span class="keywordtype">char</span>* remoteName)
<a name="l00749"></a>00749   {
<a name="l00750"></a>00750     <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;save(\&quot;%s\&quot;, \&quot;&quot;</span>, remoteName);
<a name="l00751"></a>00751     <a class="code" href="group___sending.html#gab320917c135debc6620a6706d1b3db97" title="Send binary data.">sendBin</a>(buffer, length);
<a name="l00752"></a>00752     <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<span class="stringliteral">&quot;\&quot;);&quot;</span>);
<a name="l00753"></a>00753     <a class="code" href="classurbi_1_1_u_abstract_client.html#a3d4b01fad9681a48f59aaa3bad71f820">sendBufferLock</a>.unlock();
<a name="l00754"></a>00754     <span class="keywordflow">return</span> 0;
<a name="l00755"></a>00755   }
<a name="l00756"></a>00756 
<a name="l00757"></a>00757   std::string
<a name="l00758"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a6f075608171433ec592bf603f1d7d768">00758</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a6f075608171433ec592bf603f1d7d768" title="Return a identifier, for tags for instance.">UAbstractClient::fresh</a>()
<a name="l00759"></a>00759   {
<a name="l00760"></a>00760     <span class="keyword">static</span> boost::format fmt(<span class="stringliteral">&quot;URBI_%s&quot;</span>);
<a name="l00761"></a>00761     <span class="keywordflow">return</span> str(fmt % ++<a class="code" href="classurbi_1_1_u_abstract_client.html#aad17fcf7e47d23546a12348f396ee6c7" title="A counter, used to generate unique (tag) identifiers.">counter_</a>);
<a name="l00762"></a>00762   }
<a name="l00763"></a>00763 
<a name="l00764"></a>00764   <span class="keywordtype">void</span>
<a name="l00765"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a2df0148c8f28aed4c07b6c6a4b81f616">00765</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a2df0148c8f28aed4c07b6c6a4b81f616" title="Fill tag with a unique tag for this client.">UAbstractClient::makeUniqueTag</a>(<span class="keywordtype">char</span>* tag)
<a name="l00766"></a>00766   {
<a name="l00767"></a>00767     strcpy(tag, <a class="code" href="classurbi_1_1_u_abstract_client.html#a6f075608171433ec592bf603f1d7d768" title="Return a identifier, for tags for instance.">fresh</a>().c_str());
<a name="l00768"></a>00768   }
<a name="l00769"></a>00769 
<a name="l00770"></a>00770   <span class="keywordtype">bool</span>
<a name="l00771"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a27a76b1e89a52b88f57ab7a592811f93">00771</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a27a76b1e89a52b88f57ab7a592811f93" title="New binary data is available.">UAbstractClient::process_recv_buffer_binary_</a>()
<a name="l00772"></a>00772   {
<a name="l00773"></a>00773     <span class="comment">//Receiving binary. Append to binaryBuffer;</span>
<a name="l00774"></a>00774     <span class="keywordtype">size_t</span> len =
<a name="l00775"></a>00775       std::min(<a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a> - <a class="code" href="classurbi_1_1_u_abstract_client.html#a1d09d71d70153825632b14a1bdbf5b43" title="Position of end of header.">endOfHeaderPosition</a>,
<a name="l00776"></a>00776                <a class="code" href="classurbi_1_1_u_abstract_client.html#af7aa4e0d64509a73e56cbc8f7601cc4c" title="Size of binaryBuffer.">binaryBufferLength</a> - <a class="code" href="classurbi_1_1_u_abstract_client.html#ac5868a7acc525df500196c65f0de430f" title="Current position in binaryBuffer.">binaryBufferPosition</a>);
<a name="l00777"></a>00777     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a562ea3251d82e6e37e469d0a01d3bae4" title="Temporary storage of binary data.">binaryBuffer</a>)
<a name="l00778"></a>00778       memcpy (static_cast&lt;char*&gt; (<a class="code" href="classurbi_1_1_u_abstract_client.html#a562ea3251d82e6e37e469d0a01d3bae4" title="Temporary storage of binary data.">binaryBuffer</a>) + <a class="code" href="classurbi_1_1_u_abstract_client.html#ac5868a7acc525df500196c65f0de430f" title="Current position in binaryBuffer.">binaryBufferPosition</a>,
<a name="l00779"></a>00779               <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a> + <a class="code" href="classurbi_1_1_u_abstract_client.html#a1d09d71d70153825632b14a1bdbf5b43" title="Position of end of header.">endOfHeaderPosition</a>, len);
<a name="l00780"></a>00780     <a class="code" href="classurbi_1_1_u_abstract_client.html#ac5868a7acc525df500196c65f0de430f" title="Current position in binaryBuffer.">binaryBufferPosition</a> += len;
<a name="l00781"></a>00781 
<a name="l00782"></a>00782     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#ac5868a7acc525df500196c65f0de430f" title="Current position in binaryBuffer.">binaryBufferPosition</a> == <a class="code" href="classurbi_1_1_u_abstract_client.html#af7aa4e0d64509a73e56cbc8f7601cc4c" title="Size of binaryBuffer.">binaryBufferLength</a>)
<a name="l00783"></a>00783     {
<a name="l00784"></a>00784       <span class="comment">//Finished receiving binary.</span>
<a name="l00785"></a>00785       <span class="comment">//append</span>
<a name="l00786"></a>00786       <a class="code" href="classurbi_1_1_binary_data.html">BinaryData</a> bd;
<a name="l00787"></a>00787       bd.<a class="code" href="classurbi_1_1_binary_data.html#ad1ad17e42bc09749948c5158175cfd39">size</a> = <a class="code" href="classurbi_1_1_u_abstract_client.html#af7aa4e0d64509a73e56cbc8f7601cc4c" title="Size of binaryBuffer.">binaryBufferLength</a>;
<a name="l00788"></a>00788       bd.<a class="code" href="classurbi_1_1_binary_data.html#a56877adbdba9010d06d5fb60f987bed4">data</a> = <a class="code" href="classurbi_1_1_u_abstract_client.html#a562ea3251d82e6e37e469d0a01d3bae4" title="Temporary storage of binary data.">binaryBuffer</a>;
<a name="l00789"></a>00789       <a class="code" href="classurbi_1_1_u_abstract_client.html#af0c90d1a318e4794c411beb5920da6fc" title="Bin object for this command.">bins</a> &lt;&lt; bd;
<a name="l00790"></a>00790       <a class="code" href="classurbi_1_1_u_abstract_client.html#a562ea3251d82e6e37e469d0a01d3bae4" title="Temporary storage of binary data.">binaryBuffer</a> = 0;
<a name="l00791"></a>00791 
<a name="l00792"></a>00792       <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a7f8346f4954345e7d7715e8a9ac32c2c" title="Current depth of bracket.">nBracket</a> == 0)
<a name="l00793"></a>00793       {
<a name="l00794"></a>00794         <span class="comment">//end of command, send</span>
<a name="l00795"></a>00795         <span class="comment">//dumb listLock.lock();</span>
<a name="l00796"></a>00796         <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a> msg(*<span class="keyword">this</span>, <a class="code" href="classurbi_1_1_u_abstract_client.html#aec433c7c9c6985253fb83b8e3d1aed9a">currentTimestamp</a>, <a class="code" href="classurbi_1_1_u_abstract_client.html#a4ddf70e18e6b0ace5090da3c5d25caec">currentTag</a>, <a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a>,
<a name="l00797"></a>00797                      <a class="code" href="classurbi_1_1_u_abstract_client.html#af0c90d1a318e4794c411beb5920da6fc" title="Bin object for this command.">bins</a>);
<a name="l00798"></a>00798         <a class="code" href="classurbi_1_1_u_abstract_client.html#a0752fafd9cfaa6f452d0963314c076a9" title="Pass the given UMessage to all registered callbacks with the corresponding tag, as if it were comming...">notifyCallbacks</a>(msg);
<a name="l00799"></a>00799         <span class="comment">//unlistLock.lock();</span>
<a name="l00800"></a>00800 
<a name="l00801"></a>00801         <a class="code" href="classurbi_1_1_u_abstract_client.html#ad23d1fff07aa8987bb7f80500afb2f31" title="Empty bins.">bins_clear</a>();
<a name="l00802"></a>00802 
<a name="l00803"></a>00803         <span class="comment">//flush</span>
<a name="l00804"></a>00804         <a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a> = 0;
<a name="l00805"></a>00805         <span class="comment">//Move the extra we received</span>
<a name="l00806"></a>00806         <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a> -= len + <a class="code" href="classurbi_1_1_u_abstract_client.html#a1d09d71d70153825632b14a1bdbf5b43" title="Position of end of header.">endOfHeaderPosition</a>;
<a name="l00807"></a>00807         memmove(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>,
<a name="l00808"></a>00808                 <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a> + endOfHeaderPosition + len,
<a name="l00809"></a>00809                 <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a>);
<a name="l00810"></a>00810       }
<a name="l00811"></a>00811       <span class="keywordflow">else</span>
<a name="l00812"></a>00812       {
<a name="l00813"></a>00813         <span class="comment">// not over yet</span>
<a name="l00814"></a>00814         <span class="comment">//leave parseposition where it is</span>
<a name="l00815"></a>00815         <span class="comment">//move the extra (parsePosition = endOfHeaderPosition)</span>
<a name="l00816"></a>00816         <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a> -= len;
<a name="l00817"></a>00817         memmove(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a> + <a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a>,
<a name="l00818"></a>00818                 <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a> + <a class="code" href="classurbi_1_1_u_abstract_client.html#a1d09d71d70153825632b14a1bdbf5b43" title="Position of end of header.">endOfHeaderPosition</a> + len,
<a name="l00819"></a>00819                 <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a> - <a class="code" href="classurbi_1_1_u_abstract_client.html#a1d09d71d70153825632b14a1bdbf5b43" title="Position of end of header.">endOfHeaderPosition</a>);
<a name="l00820"></a>00820       }
<a name="l00821"></a>00821       <a class="code" href="classurbi_1_1_u_abstract_client.html#a562ea3251d82e6e37e469d0a01d3bae4" title="Temporary storage of binary data.">binaryBuffer</a> = 0;
<a name="l00822"></a>00822       <a class="code" href="classurbi_1_1_u_abstract_client.html#a5f3236ccbb5c115e74671de5ec240155" title="Currently parsing binary.">binaryMode</a> = <span class="keyword">false</span>;
<a name="l00823"></a>00823 
<a name="l00824"></a>00824       <span class="comment">// Reenter loop.</span>
<a name="l00825"></a>00825       <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00826"></a>00826     }
<a name="l00827"></a>00827     <span class="keywordflow">else</span>
<a name="l00828"></a>00828     {
<a name="l00829"></a>00829       <span class="comment">// Not finished receiving binary.</span>
<a name="l00830"></a>00830       <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a> = <a class="code" href="classurbi_1_1_u_abstract_client.html#a1d09d71d70153825632b14a1bdbf5b43" title="Position of end of header.">endOfHeaderPosition</a>;
<a name="l00831"></a>00831       <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00832"></a>00832     }
<a name="l00833"></a>00833   }
<a name="l00834"></a>00834 
<a name="l00835"></a>00835   <span class="keywordtype">bool</span>
<a name="l00836"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a070559985676507cdf01c6666aa0aba2">00836</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a070559985676507cdf01c6666aa0aba2" title="New text data is available.">UAbstractClient::process_recv_buffer_text_</a>()
<a name="l00837"></a>00837   {
<a name="l00838"></a>00838     <span class="comment">// Not in binary mode.</span>
<a name="l00839"></a>00839     <span class="keywordtype">char</span>* endline =
<a name="l00840"></a>00840       <span class="keyword">static_cast&lt;</span><span class="keywordtype">char</span>*<span class="keyword">&gt;</span> (memchr(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>+<a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a>, <span class="charliteral">&#39;\n&#39;</span>,
<a name="l00841"></a>00841                                  <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a> - <a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a>));
<a name="l00842"></a>00842     <span class="keywordflow">if</span> (!endline)
<a name="l00843"></a>00843       <span class="keywordflow">return</span> <span class="keyword">false</span>; <span class="comment">//no new end of command/start of binary: wait</span>
<a name="l00844"></a>00844 
<a name="l00845"></a>00845     <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a> == 0) <span class="comment">// parse header</span>
<a name="l00846"></a>00846     {
<a name="l00847"></a>00847       <span class="comment">// Ignore empty lines.</span>
<a name="l00848"></a>00848       <span class="keywordflow">if</span> (endline == <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>)
<a name="l00849"></a>00849       {
<a name="l00850"></a>00850         memmove(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>, <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>+1, <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a> - 1);
<a name="l00851"></a>00851         <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a>--;
<a name="l00852"></a>00852         <span class="keywordflow">return</span> <span class="keyword">true</span>;
<a name="l00853"></a>00853       }
<a name="l00854"></a>00854 
<a name="l00855"></a>00855       <span class="keywordflow">if</span> (2 != sscanf(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>, <span class="stringliteral">&quot;[%d:%64[A-Za-z0-9_.]]&quot;</span>,
<a name="l00856"></a>00856                       &amp;<a class="code" href="classurbi_1_1_u_abstract_client.html#aec433c7c9c6985253fb83b8e3d1aed9a">currentTimestamp</a>, <a class="code" href="classurbi_1_1_u_abstract_client.html#a4ddf70e18e6b0ace5090da3c5d25caec">currentTag</a>))
<a name="l00857"></a>00857       {
<a name="l00858"></a>00858         <span class="keywordflow">if</span> (1 == sscanf(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>, <span class="stringliteral">&quot;[%d]&quot;</span>, &amp;<a class="code" href="classurbi_1_1_u_abstract_client.html#aec433c7c9c6985253fb83b8e3d1aed9a">currentTimestamp</a>))
<a name="l00859"></a>00859           <a class="code" href="classurbi_1_1_u_abstract_client.html#a4ddf70e18e6b0ace5090da3c5d25caec">currentTag</a>[0] = 0;
<a name="l00860"></a>00860         <span class="keywordflow">else</span>
<a name="l00861"></a>00861         {
<a name="l00862"></a>00862           <span class="comment">// failure</span>
<a name="l00863"></a>00863           GD_FERROR(<span class="stringliteral">&quot;read, error parsing header: &#39;%s&#39;&quot;</span>, <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>);
<a name="l00864"></a>00864           <a class="code" href="classurbi_1_1_u_abstract_client.html#aec433c7c9c6985253fb83b8e3d1aed9a">currentTimestamp</a> = 0;
<a name="l00865"></a>00865           strcpy(<a class="code" href="classurbi_1_1_u_abstract_client.html#a4ddf70e18e6b0ace5090da3c5d25caec">currentTag</a>, <span class="stringliteral">&quot;UNKNWN&quot;</span>);
<a name="l00866"></a>00866           <span class="comment">//listLock.lock();</span>
<a name="l00867"></a>00867           <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a> msg(*<span class="keyword">this</span>, 0, <a class="code" href="namespaceurbi.html#ac9433e2a7062103d7feee4276d52c0ce" title="Fake tag to treat error message with tags.">tag_error</a>,
<a name="l00868"></a>00868                        <span class="stringliteral">&quot;!!! UAbstractClient::read, fatal error parsing header&quot;</span>,
<a name="l00869"></a>00869                        <a class="code" href="namespaceurbi.html#a28dbd07b21d724058b728eb09fe5c77f" title="List of the binaries.">binaries_type</a>());
<a name="l00870"></a>00870           <a class="code" href="classurbi_1_1_u_abstract_client.html#a0752fafd9cfaa6f452d0963314c076a9" title="Pass the given UMessage to all registered callbacks with the corresponding tag, as if it were comming...">notifyCallbacks</a>(msg);
<a name="l00871"></a>00871           <span class="comment">//unlistLock.lock();</span>
<a name="l00872"></a>00872         }
<a name="l00873"></a>00873       }
<a name="l00874"></a>00874 
<a name="l00875"></a>00875       <a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a> = strstr(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>, <span class="stringliteral">&quot;]&quot;</span>);
<a name="l00876"></a>00876       <span class="keywordflow">if</span> (!<a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a>)
<a name="l00877"></a>00877       {
<a name="l00878"></a>00878         <span class="comment">//reset all</span>
<a name="l00879"></a>00879         <a class="code" href="classurbi_1_1_u_abstract_client.html#a7f8346f4954345e7d7715e8a9ac32c2c" title="Current depth of bracket.">nBracket</a> = 0;
<a name="l00880"></a>00880         <a class="code" href="classurbi_1_1_u_abstract_client.html#a521f405a801d01a1a7a3fa7c6d3521f6" title="True if preparsing is in a string.">inString</a> = <span class="keyword">false</span>;
<a name="l00881"></a>00881         <a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a> = 0;
<a name="l00882"></a>00882         <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a> = 0;
<a name="l00883"></a>00883         <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00884"></a>00884       }
<a name="l00885"></a>00885 
<a name="l00886"></a>00886       ++<a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a>;
<a name="l00887"></a>00887       <span class="keywordflow">while</span> (*<a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a> == <span class="charliteral">&#39; &#39;</span>)
<a name="l00888"></a>00888         ++<a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a>;
<a name="l00889"></a>00889       <a class="code" href="classurbi_1_1_u_abstract_client.html#a2131158b4784748c32eae46a05c8367f" title="Parsing a system message.">system</a> = (*<a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a> == <span class="charliteral">&#39;!&#39;</span> || *<a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a> == <span class="charliteral">&#39;*&#39;</span>);
<a name="l00890"></a>00890       <a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a> = (long) <a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a> - (<span class="keywordtype">long</span>) <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>;
<a name="l00891"></a>00891 
<a name="l00892"></a>00892       <span class="comment">//reinit just to be sure:</span>
<a name="l00893"></a>00893       <a class="code" href="classurbi_1_1_u_abstract_client.html#a7f8346f4954345e7d7715e8a9ac32c2c" title="Current depth of bracket.">nBracket</a> = 0;
<a name="l00894"></a>00894       <a class="code" href="classurbi_1_1_u_abstract_client.html#a521f405a801d01a1a7a3fa7c6d3521f6" title="True if preparsing is in a string.">inString</a> = <span class="keyword">false</span>;
<a name="l00895"></a>00895     }
<a name="l00896"></a>00896 
<a name="l00897"></a>00897     <span class="keywordflow">for</span> (<span class="comment">/* nothing */</span>; <a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a> &lt; <a class="code" href="classurbi_1_1_u_abstract_client.html#a20a21d392ddff58d448ea14624f767a4" title="Current position in reception buffer.">recvBufferPosition</a>; ++<a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a>)
<a name="l00898"></a>00898     {
<a name="l00899"></a>00899       <span class="keywordflow">if</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a521f405a801d01a1a7a3fa7c6d3521f6" title="True if preparsing is in a string.">inString</a>)
<a name="l00900"></a>00900         <span class="keywordflow">switch</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>[<a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a>])
<a name="l00901"></a>00901         {
<a name="l00902"></a>00902         <span class="keywordflow">case</span> <span class="charliteral">&#39;\\&#39;</span>:
<a name="l00903"></a>00903           <span class="keywordflow">if</span> (parsePosition == recvBufferPosition-1)
<a name="l00904"></a>00904             <span class="comment">//we cant handle the &#39;\\&#39;</span>
<a name="l00905"></a>00905             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00906"></a>00906           ++parsePosition; <span class="comment">//ignore next character</span>
<a name="l00907"></a>00907           <span class="keywordflow">continue</span>;
<a name="l00908"></a>00908         <span class="keywordflow">case</span> <span class="charliteral">&#39;&quot;&#39;</span>:
<a name="l00909"></a>00909           <a class="code" href="classurbi_1_1_u_abstract_client.html#a521f405a801d01a1a7a3fa7c6d3521f6" title="True if preparsing is in a string.">inString</a> = <span class="keyword">false</span>;
<a name="l00910"></a>00910           <span class="keywordflow">continue</span>;
<a name="l00911"></a>00911         }
<a name="l00912"></a>00912       <span class="keywordflow">else</span>
<a name="l00913"></a>00913       {
<a name="l00914"></a>00914         <span class="keywordflow">switch</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>[parsePosition])
<a name="l00915"></a>00915         {
<a name="l00916"></a>00916         <span class="keywordflow">case</span> <span class="charliteral">&#39;&quot;&#39;</span>:
<a name="l00917"></a>00917           <a class="code" href="classurbi_1_1_u_abstract_client.html#a521f405a801d01a1a7a3fa7c6d3521f6" title="True if preparsing is in a string.">inString</a> = <span class="keyword">true</span>;
<a name="l00918"></a>00918           <span class="keywordflow">continue</span>;
<a name="l00919"></a>00919         <span class="keywordflow">case</span> <span class="charliteral">&#39;[&#39;</span>:
<a name="l00920"></a>00920           ++<a class="code" href="classurbi_1_1_u_abstract_client.html#a7f8346f4954345e7d7715e8a9ac32c2c" title="Current depth of bracket.">nBracket</a>;
<a name="l00921"></a>00921           <span class="keywordflow">continue</span>;
<a name="l00922"></a>00922         <span class="keywordflow">case</span> <span class="charliteral">&#39;]&#39;</span>:
<a name="l00923"></a>00923           --<a class="code" href="classurbi_1_1_u_abstract_client.html#a7f8346f4954345e7d7715e8a9ac32c2c" title="Current depth of bracket.">nBracket</a>;
<a name="l00924"></a>00924           <span class="keywordflow">continue</span>;
<a name="l00925"></a>00925         <span class="keywordflow">case</span> <span class="charliteral">&#39;\n&#39;</span>:
<a name="l00926"></a>00926           <span class="comment">/* XXX: handle &#39;[&#39; in echoed messages or errors nBracket == 0 */</span>
<a name="l00927"></a>00927           <span class="comment">//end of command</span>
<a name="l00928"></a>00928           <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>[parsePosition]=0;
<a name="l00929"></a>00929           <span class="comment">//listLock.lock();</span>
<a name="l00930"></a>00930           <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a> msg(*<span class="keyword">this</span>, <a class="code" href="classurbi_1_1_u_abstract_client.html#aec433c7c9c6985253fb83b8e3d1aed9a">currentTimestamp</a>, <a class="code" href="classurbi_1_1_u_abstract_client.html#a4ddf70e18e6b0ace5090da3c5d25caec">currentTag</a>,
<a name="l00931"></a>00931                        <a class="code" href="classurbi_1_1_u_abstract_client.html#a405f3558ebcddc4962e4d3e029f5e1a6" title="Start of command, after [ts:tag] header.">currentCommand</a>,
<a name="l00932"></a>00932                        <a class="code" href="classurbi_1_1_u_abstract_client.html#af0c90d1a318e4794c411beb5920da6fc" title="Bin object for this command.">bins</a>);
<a name="l00933"></a>00933           <a class="code" href="classurbi_1_1_u_abstract_client.html#a0752fafd9cfaa6f452d0963314c076a9" title="Pass the given UMessage to all registered callbacks with the corresponding tag, as if it were comming...">notifyCallbacks</a>(msg);
<a name="l00934"></a>00934           <span class="comment">//unlistLock.lock();</span>
<a name="l00935"></a>00935           <span class="comment">//prepare for next read, copy the extra</span>
<a name="l00936"></a>00936           memmove(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>, <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a> + parsePosition + 1,
<a name="l00937"></a>00937                   recvBufferPosition - parsePosition - 1);
<a name="l00938"></a>00938           <span class="comment">// copy beginning of next cmd</span>
<a name="l00939"></a>00939           recvBufferPosition = recvBufferPosition - parsePosition - 1;
<a name="l00940"></a>00940           <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>[recvBufferPosition] = 0;
<a name="l00941"></a>00941           parsePosition = 0;
<a name="l00942"></a>00942           <a class="code" href="classurbi_1_1_u_abstract_client.html#ad23d1fff07aa8987bb7f80500afb2f31" title="Empty bins.">bins_clear</a>();
<a name="l00943"></a>00943           <span class="keywordflow">goto</span> line_finished; <span class="comment">//restart</span>
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945 
<a name="l00946"></a>00946         <span class="keywordflow">if</span> (!<a class="code" href="classurbi_1_1_u_abstract_client.html#a2131158b4784748c32eae46a05c8367f" title="Parsing a system message.">system</a> &amp;&amp; !strncmp(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>+parsePosition-3, <span class="stringliteral">&quot;BIN &quot;</span>, 4))
<a name="l00947"></a>00947         {
<a name="l00948"></a>00948           <span class="comment">//very important: scan starts below current point</span>
<a name="l00949"></a>00949           <span class="comment">//compute length</span>
<a name="l00950"></a>00950           <span class="keywordtype">char</span>* endLength;
<a name="l00951"></a>00951           <a class="code" href="classurbi_1_1_u_abstract_client.html#af7aa4e0d64509a73e56cbc8f7601cc4c" title="Size of binaryBuffer.">binaryBufferLength</a> =
<a name="l00952"></a>00952             strtol(<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>+parsePosition+1, &amp;endLength, 0);
<a name="l00953"></a>00953           <span class="keywordflow">if</span> (endLength == <a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>+parsePosition+1)
<a name="l00954"></a>00954           {
<a name="l00955"></a>00955             GD_ERROR(<span class="stringliteral">&quot;read, error parsing bin data length.&quot;</span>);
<a name="l00956"></a>00956             recvBufferPosition = 0;
<a name="l00957"></a>00957             <span class="keywordflow">return</span> <span class="keyword">false</span>;
<a name="l00958"></a>00958           }
<a name="l00959"></a>00959           <span class="comment">//go to end of header</span>
<a name="l00960"></a>00960           <span class="keywordflow">while</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a25acc624061c77a53991c0e565c32b8f" title="Reception buffer.">recvBuffer</a>[parsePosition] !=<span class="charliteral">&#39;\n&#39;</span>)
<a name="l00961"></a>00961             ++parsePosition; <span class="comment">//we now we will find a \n</span>
<a name="l00962"></a>00962           ++parsePosition;
<a name="l00963"></a>00963           <a class="code" href="classurbi_1_1_u_abstract_client.html#a1d09d71d70153825632b14a1bdbf5b43" title="Position of end of header.">endOfHeaderPosition</a> = parsePosition;
<a name="l00964"></a>00964           <a class="code" href="classurbi_1_1_u_abstract_client.html#a5f3236ccbb5c115e74671de5ec240155" title="Currently parsing binary.">binaryMode</a> = <span class="keyword">true</span>;
<a name="l00965"></a>00965           <a class="code" href="classurbi_1_1_u_abstract_client.html#a562ea3251d82e6e37e469d0a01d3bae4" title="Temporary storage of binary data.">binaryBuffer</a> = malloc(<a class="code" href="classurbi_1_1_u_abstract_client.html#af7aa4e0d64509a73e56cbc8f7601cc4c" title="Size of binaryBuffer.">binaryBufferLength</a>);
<a name="l00966"></a>00966           <a class="code" href="classurbi_1_1_u_abstract_client.html#ac5868a7acc525df500196c65f0de430f" title="Current position in binaryBuffer.">binaryBufferPosition</a> = 0;
<a name="l00967"></a>00967           <span class="keywordflow">break</span>; <span class="comment">//restart in binarymode to handle binary</span>
<a name="l00968"></a>00968         }
<a name="l00969"></a>00969       }
<a name="l00970"></a>00970     }
<a name="l00971"></a>00971   line_finished:
<a name="l00972"></a>00972     <span class="comment">// Either we ate all characters, or we were asked to restart.</span>
<a name="l00973"></a>00973     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#aae6ed4c75bb5252c681769c3b042707b" title="Position of parse in recvBuffer.">parsePosition</a> != recvBufferPosition;
<a name="l00974"></a>00974   }
<a name="l00975"></a>00975 
<a name="l00980"></a>00980   <span class="keywordtype">void</span>
<a name="l00981"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a7677133cc15f4cf48f077992041d37f8">00981</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a7677133cc15f4cf48f077992041d37f8" title="Called each time new data is available in recvBuffer.">UAbstractClient::processRecvBuffer</a>()
<a name="l00982"></a>00982   {
<a name="l00983"></a>00983     <span class="keywordflow">while</span> (<a class="code" href="classurbi_1_1_u_abstract_client.html#a5f3236ccbb5c115e74671de5ec240155" title="Currently parsing binary.">binaryMode</a>
<a name="l00984"></a>00984            ? <a class="code" href="classurbi_1_1_u_abstract_client.html#a27a76b1e89a52b88f57ab7a592811f93" title="New binary data is available.">process_recv_buffer_binary_</a>()
<a name="l00985"></a>00985            : <a class="code" href="classurbi_1_1_u_abstract_client.html#a070559985676507cdf01c6666aa0aba2" title="New text data is available.">process_recv_buffer_text_</a>())
<a name="l00986"></a>00986       <span class="keywordflow">continue</span>;
<a name="l00987"></a>00987   }
<a name="l00988"></a>00988 
<a name="l00989"></a>00989   <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a>
<a name="l00990"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a161dc8bb4e50bf63a9f666c9a3722ec7">00990</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a161dc8bb4e50bf63a9f666c9a3722ec7" title="Associate a callback with all messages.">UAbstractClient::setWildcardCallback</a>(<a class="code" href="classurbi_1_1_u_callback_wrapper.html" title="Wrapper around a callback function. Use callback() to create them.">UCallbackWrapper</a>&amp; <a class="code" href="namespaceurbi.html#a384e3312cf097fdbbe068d2647f46f13" title="Generate a callback wrapper used by UAbstractClient::setCallback().">callback</a>)
<a name="l00991"></a>00991   {
<a name="l00992"></a>00992     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#ab69addc60209eb96cbfe25b99ff22812" title="Add a callback to the list.">addCallback</a>(<a class="code" href="namespaceurbi.html#a1984085fcfa97e463e2959160ba461fc" title="Fake tag to catch all the messages.">tag_wildcard</a>, callback);
<a name="l00993"></a>00993   }
<a name="l00994"></a>00994 
<a name="l00995"></a>00995   <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a>
<a name="l00996"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#ad761d3d126c0ac2438bec78739a81a86">00996</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#ad761d3d126c0ac2438bec78739a81a86" title="Associate a callback function with all error messages from the server.">UAbstractClient::setErrorCallback</a>(<a class="code" href="classurbi_1_1_u_callback_wrapper.html" title="Wrapper around a callback function. Use callback() to create them.">UCallbackWrapper</a>&amp; <a class="code" href="namespaceurbi.html#a384e3312cf097fdbbe068d2647f46f13" title="Generate a callback wrapper used by UAbstractClient::setCallback().">callback</a>)
<a name="l00997"></a>00997   {
<a name="l00998"></a>00998     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#ab69addc60209eb96cbfe25b99ff22812" title="Add a callback to the list.">addCallback</a>(<a class="code" href="namespaceurbi.html#ac9433e2a7062103d7feee4276d52c0ce" title="Fake tag to treat error message with tags.">tag_error</a>, callback);
<a name="l00999"></a>00999   }
<a name="l01000"></a>01000 
<a name="l01001"></a>01001   <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a>
<a name="l01002"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a92f7ea2d9eebc3ea8a8b2d1b8f147a55">01002</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a92f7ea2d9eebc3ea8a8b2d1b8f147a55" title="Associate a callback with local connection errors.">UAbstractClient::setClientErrorCallback</a>(<a class="code" href="classurbi_1_1_u_callback_wrapper.html" title="Wrapper around a callback function. Use callback() to create them.">UCallbackWrapper</a>&amp; <a class="code" href="namespaceurbi.html#a384e3312cf097fdbbe068d2647f46f13" title="Generate a callback wrapper used by UAbstractClient::setCallback().">callback</a>)
<a name="l01003"></a>01003   {
<a name="l01004"></a>01004     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#ab69addc60209eb96cbfe25b99ff22812" title="Add a callback to the list.">addCallback</a>(<a class="code" href="classurbi_1_1_u_abstract_client.html#a53dd8f73b147dace05495e27c20ee3ad" title="dummy tag for client error callback.">CLIENTERROR_TAG</a>, callback);
<a name="l01005"></a>01005   }
<a name="l01006"></a>01006 
<a name="l01007"></a>01007   <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a>
<a name="l01008"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a574c8f649ce663ebc5cd8211a01367aa">01008</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a574c8f649ce663ebc5cd8211a01367aa" title="Associate a callback function with a tag. New style.">UAbstractClient::setCallback</a>(<a class="code" href="classurbi_1_1_u_callback_wrapper.html" title="Wrapper around a callback function. Use callback() to create them.">UCallbackWrapper</a>&amp; <a class="code" href="namespaceurbi.html#a384e3312cf097fdbbe068d2647f46f13" title="Generate a callback wrapper used by UAbstractClient::setCallback().">callback</a>,
<a name="l01009"></a>01009                                <span class="keyword">const</span> <span class="keywordtype">char</span>* tag)
<a name="l01010"></a>01010   {
<a name="l01011"></a>01011     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#ab69addc60209eb96cbfe25b99ff22812" title="Add a callback to the list.">addCallback</a>(tag, callback);
<a name="l01012"></a>01012   }
<a name="l01013"></a>01013 
<a name="l01014"></a>01014   <a class="code" href="namespaceurbi.html#a300f2dc4551bf0de25f66a9536f086d8">UCallbackID</a>
<a name="l01015"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#ab69addc60209eb96cbfe25b99ff22812">01015</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#ab69addc60209eb96cbfe25b99ff22812" title="Add a callback to the list.">UAbstractClient::addCallback</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* tag,
<a name="l01016"></a>01016                                <a class="code" href="classurbi_1_1_u_callback_wrapper.html" title="Wrapper around a callback function. Use callback() to create them.">UCallbackWrapper</a>&amp; w)
<a name="l01017"></a>01017   {
<a name="l01018"></a>01018     <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.lock();
<a name="l01019"></a>01019     <a class="code" href="classurbi_1_1_u_callback_info.html">UCallbackInfo</a> ci(w);
<a name="l01020"></a>01020     strncpy(ci.<a class="code" href="classurbi_1_1_u_callback_info.html#ae5ea14bf3e6279f117a6a9aa58defae5">tag</a>, tag, <a class="code" href="namespaceurbi.html#ab1ad8da075182ff31ded9189dd535940aaa5e4ada4c63409bf50cf90bbee7cf62">URBI_MAX_TAG_LENGTH</a>-1);
<a name="l01021"></a>01021     ci.<a class="code" href="classurbi_1_1_u_callback_info.html#ae5ea14bf3e6279f117a6a9aa58defae5">tag</a>[<a class="code" href="namespaceurbi.html#ab1ad8da075182ff31ded9189dd535940aaa5e4ada4c63409bf50cf90bbee7cf62">URBI_MAX_TAG_LENGTH</a>-1]=0;
<a name="l01022"></a>01022     ci.<a class="code" href="classurbi_1_1_u_callback_info.html#a6b19e8fe3e5f099176d67a504e077578">id</a> = ++<a class="code" href="namespaceurbi.html#ae09eb3b0d802d03d0ddb35d494f8555c">nextId</a>;
<a name="l01023"></a>01023     <a class="code" href="classurbi_1_1_u_abstract_client.html#a633d4dc714f2eb9ab04b3f1b9e747155">callbacks_</a>.push_front(ci);
<a name="l01024"></a>01024     <a class="code" href="classurbi_1_1_u_abstract_client.html#a8302e6c4187fac3a1812b16c1446e19f">listLock</a>.unlock();
<a name="l01025"></a>01025     <span class="keywordflow">return</span> ci.<a class="code" href="classurbi_1_1_u_callback_info.html#a6b19e8fe3e5f099176d67a504e077578">id</a>;
<a name="l01026"></a>01026   }
<a name="l01027"></a>01027 
<a name="l01028"></a>01028   <span class="keywordtype">void</span>
<a name="l01029"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#ad0ea8c454eb850b95dfd9fb883de8a56">01029</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#ad0ea8c454eb850b95dfd9fb883de8a56" title="Generate a client error message and notify callbacks.">UAbstractClient::clientError</a>(std::string message, <span class="keywordtype">int</span> erc)
<a name="l01030"></a>01030   {
<a name="l01031"></a>01031     <span class="comment">// Like in UMessage&#39;s constructor, skip the possible &quot;!!! &quot;</span>
<a name="l01032"></a>01032     <span class="comment">// prefix.</span>
<a name="l01033"></a>01033     <span class="keyword">const</span> <span class="keywordtype">char</span> prefix[] = <span class="stringliteral">&quot;!!! &quot;</span>;
<a name="l01034"></a>01034     <span class="keywordflow">if</span> (message.substr(0, <span class="keyword">sizeof</span> prefix - 1) == prefix)
<a name="l01035"></a>01035       message.erase(0, <span class="keyword">sizeof</span> prefix - 1);
<a name="l01036"></a>01036 
<a name="l01037"></a>01037     <span class="keywordflow">if</span> (erc)
<a name="l01038"></a>01038     {
<a name="l01039"></a>01039       message += message.empty() ? <span class="stringliteral">&quot;&quot;</span> : <span class="stringliteral">&quot;: &quot;</span>;
<a name="l01040"></a>01040       message += libport::strerror(erc);
<a name="l01041"></a>01041     }
<a name="l01042"></a>01042 
<a name="l01043"></a>01043     <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a> m(*<span class="keyword">this</span>);
<a name="l01044"></a>01044     m.<a class="code" href="classurbi_1_1_u_message.html#a49559da7ba6d92767746adf62035a2c3" title="The type of this message.">type</a> = MESSAGE_ERROR;
<a name="l01045"></a>01045     <span class="comment">// rawMessage is incorrect but we don&#39;t care.</span>
<a name="l01046"></a>01046     m.<a class="code" href="classurbi_1_1_u_message.html#abf97f44601ed84972562fc2377061c4b" title="Set only if the message type is MESSAGE_SYSTEM or MESSAGE_ERROR.">message</a> = m.<a class="code" href="classurbi_1_1_u_message.html#aa77bd3b34c0d777b0a6317d9ad1b60da" title="Raw message without the binary data.">rawMessage</a> = message;
<a name="l01047"></a>01047     m.<a class="code" href="classurbi_1_1_u_message.html#a02a671d358699d25051d3ef4b238a87c" title="Server-side timestamp.">timestamp</a> = 0;
<a name="l01048"></a>01048     m.<a class="code" href="classurbi_1_1_u_message.html#a663f67700bf8eaa3fcb859e018466403" title="Associated tag.">tag</a> = <a class="code" href="classurbi_1_1_u_abstract_client.html#a53dd8f73b147dace05495e27c20ee3ad" title="dummy tag for client error callback.">CLIENTERROR_TAG</a>;
<a name="l01049"></a>01049     <a class="code" href="classurbi_1_1_u_abstract_client.html#a0752fafd9cfaa6f452d0963314c076a9" title="Pass the given UMessage to all registered callbacks with the corresponding tag, as if it were comming...">notifyCallbacks</a>(m);
<a name="l01050"></a>01050   }
<a name="l01051"></a>01051 
<a name="l01052"></a>01052   <span class="keywordtype">void</span>
<a name="l01053"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a69c0413b4ec9c26fa9c530d7e5ea3637">01053</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#ad0ea8c454eb850b95dfd9fb883de8a56" title="Generate a client error message and notify callbacks.">UAbstractClient::clientError</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* message, <span class="keywordtype">int</span> erc)
<a name="l01054"></a>01054   {
<a name="l01055"></a>01055     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#ad0ea8c454eb850b95dfd9fb883de8a56" title="Generate a client error message and notify callbacks.">clientError</a>(std::string(message ? message : <span class="stringliteral">&quot;&quot;</span>), erc);
<a name="l01056"></a>01056   }
<a name="l01057"></a>01057 
<a name="l01058"></a>01058   <span class="keywordtype">void</span>
<a name="l01059"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a77e4ea290f07eccfbae90a73cc9175c9">01059</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a77e4ea290f07eccfbae90a73cc9175c9" title="Must be called by subclasses when the connection is established.">UAbstractClient::onConnection</a>()
<a name="l01060"></a>01060   {
<a name="l01061"></a>01061 <span class="preprocessor"># define VERSION_TAG TAG_PRIVATE_PREFIX &quot;__version&quot;</span>
<a name="l01062"></a>01062 <span class="preprocessor"></span>    <a class="code" href="classurbi_1_1_u_abstract_client.html#a574c8f649ce663ebc5cd8211a01367aa" title="Associate a callback function with a tag. New style.">setCallback</a>(*<span class="keyword">this</span>, &amp;<a class="code" href="classurbi_1_1_u_abstract_client.html#a711b425a1dd68863d2cd8e912273589d" title="A callback, installed by onConnection(), that reads an answer from the server to know if it&amp;#39;s k1 ...">UAbstractClient::setVersion</a>, <a class="code" href="uabstractclient_8cc.html#aed90ca0652e9fe4d4876be6bb37c1c22">VERSION_TAG</a>);
<a name="l01063"></a>01063     <span class="comment">// We don&#39;t know our kernel version yet.</span>
<a name="l01064"></a>01064     <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<a class="code" href="uvalue_8hh.html#a68ff1679095cf52290483daa7da9b911">SYNCLINE_WRAP</a>(
<a name="l01065"></a>01065            <span class="stringliteral">&quot;{\n&quot;</span>
<a name="l01066"></a>01066            <span class="stringliteral">&quot;  var __ver__ = 2;\n&quot;</span>
<a name="l01067"></a>01067            <span class="stringliteral">&quot;  {var __ver__ = 1};\n&quot;</span>
<a name="l01068"></a>01068            <span class="stringliteral">&quot;  var &quot;</span> <a class="code" href="uabstractclient_8cc.html#aed90ca0652e9fe4d4876be6bb37c1c22">VERSION_TAG</a> <span class="stringliteral">&quot;;\n&quot;</span>
<a name="l01069"></a>01069            <span class="stringliteral">&quot;  if (__ver__ == 1)\n&quot;</span>
<a name="l01070"></a>01070            <span class="stringliteral">&quot;    &quot;</span> <a class="code" href="uabstractclient_8cc.html#aed90ca0652e9fe4d4876be6bb37c1c22">VERSION_TAG</a> <span class="stringliteral">&quot; &lt;&lt; system.version\n&quot;</span>
<a name="l01071"></a>01071            <span class="stringliteral">&quot;  else\n&quot;</span>
<a name="l01072"></a>01072            <span class="stringliteral">&quot;  {\n&quot;</span>
<a name="l01073"></a>01073            <span class="stringliteral">&quot;    &quot;</span> <a class="code" href="uabstractclient_8cc.html#aed90ca0652e9fe4d4876be6bb37c1c22">VERSION_TAG</a> <span class="stringliteral">&quot; = Channel.new(\&quot;&quot;</span> <a class="code" href="uabstractclient_8cc.html#aed90ca0652e9fe4d4876be6bb37c1c22">VERSION_TAG</a> <span class="stringliteral">&quot;\&quot;);\n&quot;</span>
<a name="l01074"></a>01074            <span class="stringliteral">&quot;    &quot;</span> <a class="code" href="uabstractclient_8cc.html#aed90ca0652e9fe4d4876be6bb37c1c22">VERSION_TAG</a> <span class="stringliteral">&quot; &lt;&lt; System.version;\n&quot;</span>
<a name="l01075"></a>01075            <span class="stringliteral">&quot;  };\n&quot;</span>
<a name="l01076"></a>01076            <span class="stringliteral">&quot;};\n&quot;</span>));
<a name="l01077"></a>01077 <span class="preprocessor"># undef VERSION_TAG</span>
<a name="l01078"></a>01078 <span class="preprocessor"></span>  }
<a name="l01079"></a>01079 
<a name="l01080"></a>01080   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l01081"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#aab592eb34015778429de0dc81ccaceee">01081</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a4fe351ee52f67775fbf03bc4d1d6dd14" title="Bounce to effectiveSend() using strlen.">UAbstractClient::effective_send</a>(<span class="keyword">const</span> std::string&amp; s)
<a name="l01082"></a>01082   {
<a name="l01083"></a>01083     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#a5ebc9f1531123f579bd69083ed4a1cd2" title="Queue data for sending, returns zero on success, nonzero on failure.">effectiveSend</a>(s.c_str(), s.size());
<a name="l01084"></a>01084   }
<a name="l01085"></a>01085 
<a name="l01086"></a>01086   <a class="code" href="classurbi_1_1_u_abstract_client.html#ae28fd116b611e3c364c4c88feb643d60" title="Error code.">UAbstractClient::error_type</a>
<a name="l01087"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a4fe351ee52f67775fbf03bc4d1d6dd14">01087</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a4fe351ee52f67775fbf03bc4d1d6dd14" title="Bounce to effectiveSend() using strlen.">UAbstractClient::effective_send</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* cp)
<a name="l01088"></a>01088   {
<a name="l01089"></a>01089     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#a5ebc9f1531123f579bd69083ed4a1cd2" title="Queue data for sending, returns zero on success, nonzero on failure.">effectiveSend</a>(cp, strlen(cp));
<a name="l01090"></a>01090   }
<a name="l01091"></a>01091 
<a name="l01092"></a>01092   <a class="code" href="namespaceurbi.html#a63f30f52002e7e7f853a12a8c1172f41" title="Return values for the callcack functions.">UCallbackAction</a>
<a name="l01093"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a597b9f98b6e393bcd891064cec61835f">01093</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a597b9f98b6e393bcd891064cec61835f" title="A callback, installed by setVersion, that computes connectionID_.">UAbstractClient::setConnectionID</a>(<span class="keyword">const</span> <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a>&amp; msg)
<a name="l01094"></a>01094   {
<a name="l01095"></a>01095     <span class="keywordflow">if</span> (msg.<a class="code" href="classurbi_1_1_u_message.html#a49559da7ba6d92767746adf62035a2c3" title="The type of this message.">type</a> == <a class="code" href="namespaceurbi.html#af4858e704e4932543908706b6b483b69a147c0686d9f55f18146181a08ffa4a1a" title="All other messages.">MESSAGE_DATA</a> &amp;&amp; msg.<a class="code" href="classurbi_1_1_u_message.html#a5a303c98ae38e5891f65490b5fa23e23" title="Set only if the message type is MESSAGE_DATA.">value</a>)
<a name="l01096"></a>01096     {
<a name="l01097"></a>01097       std::string id(*msg.<a class="code" href="classurbi_1_1_u_message.html#a5a303c98ae38e5891f65490b5fa23e23" title="Set only if the message type is MESSAGE_DATA.">value</a>);
<a name="l01098"></a>01098       <span class="keywordflow">if</span> (!<span class="keywordtype">id</span>.empty())
<a name="l01099"></a>01099       {
<a name="l01100"></a>01100         <a class="code" href="classurbi_1_1_u_abstract_client.html#abebd6241d4e9ad282535097c87ecf1e5">connectionID_</a> = id;
<a name="l01101"></a>01101         <span class="keywordflow">return</span> URBI_REMOVE;
<a name="l01102"></a>01102       }
<a name="l01103"></a>01103     }
<a name="l01104"></a>01104     <span class="keywordflow">return</span> URBI_CONTINUE;
<a name="l01105"></a>01105   }
<a name="l01106"></a>01106 
<a name="l01107"></a>01107   <a class="code" href="namespaceurbi.html#a63f30f52002e7e7f853a12a8c1172f41" title="Return values for the callcack functions.">UCallbackAction</a>
<a name="l01108"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a711b425a1dd68863d2cd8e912273589d">01108</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a711b425a1dd68863d2cd8e912273589d" title="A callback, installed by onConnection(), that reads an answer from the server to know if it&amp;#39;s k1 ...">UAbstractClient::setVersion</a>(<span class="keyword">const</span> <a class="code" href="classurbi_1_1_u_message.html" title="Class containing all informations related to an URBI message.">UMessage</a>&amp; msg)
<a name="l01109"></a>01109   {
<a name="l01110"></a>01110     <span class="keywordflow">if</span> (msg.<a class="code" href="classurbi_1_1_u_message.html#a49559da7ba6d92767746adf62035a2c3" title="The type of this message.">type</a> != <a class="code" href="namespaceurbi.html#af4858e704e4932543908706b6b483b69a147c0686d9f55f18146181a08ffa4a1a" title="All other messages.">MESSAGE_DATA</a>)
<a name="l01111"></a>01111       <span class="keywordflow">return</span> URBI_CONTINUE;
<a name="l01112"></a>01112     passert(msg.<a class="code" href="classurbi_1_1_u_message.html#a5a303c98ae38e5891f65490b5fa23e23" title="Set only if the message type is MESSAGE_DATA.">value</a>-&gt;<a class="code" href="classurbi_1_1_u_value.html#a0300e8defe31b165b2b00ba190420f09">type</a>, msg.<a class="code" href="classurbi_1_1_u_message.html#a5a303c98ae38e5891f65490b5fa23e23" title="Set only if the message type is MESSAGE_DATA.">value</a>-&gt;<a class="code" href="classurbi_1_1_u_value.html#a0300e8defe31b165b2b00ba190420f09">type</a> == <a class="code" href="namespaceurbi.html#a5443afbb6251a2a6f54cbf3c32e59f3dab8e56bace8e5b2a8c9566c634579f9a9">DATA_STRING</a>);
<a name="l01113"></a>01113     <a class="code" href="classurbi_1_1_u_abstract_client.html#a244b05e3963f159224c586c3990285c5" title="The full kernel version as answered by the server.">kernelVersion_</a> = *msg.<a class="code" href="classurbi_1_1_u_message.html#a5a303c98ae38e5891f65490b5fa23e23" title="Set only if the message type is MESSAGE_DATA.">value</a>-&gt;<a class="code" href="classurbi_1_1_u_value.html#ae4e681e553790f3c6ec54eb31c2bd332" title="value if of type DATA_STRING">stringValue</a>;
<a name="l01114"></a>01114     <span class="keywordtype">size_t</span> sep = <a class="code" href="classurbi_1_1_u_abstract_client.html#a244b05e3963f159224c586c3990285c5" title="The full kernel version as answered by the server.">kernelVersion_</a>.find_first_of(<span class="charliteral">&#39;.&#39;</span>);
<a name="l01115"></a>01115     <span class="keywordflow">try</span>
<a name="l01116"></a>01116     {
<a name="l01117"></a>01117       <a class="code" href="classurbi_1_1_u_abstract_client.html#ac8bbfdfbfa8f47ed8f52e6725eede28f" title="The major version. -1 if not yet available.">kernelMajor_</a> = boost::lexical_cast&lt;<span class="keywordtype">int</span>&gt;(<a class="code" href="classurbi_1_1_u_abstract_client.html#a244b05e3963f159224c586c3990285c5" title="The full kernel version as answered by the server.">kernelVersion_</a>.substr(0, sep));
<a name="l01118"></a>01118       <span class="keywordtype">size_t</span> sep2 = <a class="code" href="classurbi_1_1_u_abstract_client.html#a244b05e3963f159224c586c3990285c5" title="The full kernel version as answered by the server.">kernelVersion_</a>.find_first_of(<span class="charliteral">&#39;.&#39;</span>, sep+1);
<a name="l01119"></a>01119       <span class="keywordflow">if</span> (sep2 != <a class="code" href="classurbi_1_1_u_abstract_client.html#a244b05e3963f159224c586c3990285c5" title="The full kernel version as answered by the server.">kernelVersion_</a>.npos)
<a name="l01120"></a>01120         <a class="code" href="classurbi_1_1_u_abstract_client.html#a5b77875812f97c107bd59fef227cf048" title="The minor version. -1 if not yet available.">kernelMinor_</a> =
<a name="l01121"></a>01121           boost::lexical_cast&lt;<span class="keywordtype">int</span>&gt;(<a class="code" href="classurbi_1_1_u_abstract_client.html#a244b05e3963f159224c586c3990285c5" title="The full kernel version as answered by the server.">kernelVersion_</a>.substr(sep+1,
<a name="l01122"></a>01122                                                          sep2-sep-1));
<a name="l01123"></a>01123       <span class="keywordflow">else</span>
<a name="l01124"></a>01124         <a class="code" href="classurbi_1_1_u_abstract_client.html#a5b77875812f97c107bd59fef227cf048" title="The minor version. -1 if not yet available.">kernelMinor_</a> = 0;
<a name="l01125"></a>01125     }
<a name="l01126"></a>01126     <span class="keywordflow">catch</span> (boost::bad_lexical_cast&amp;)
<a name="l01127"></a>01127     {
<a name="l01128"></a>01128       <a class="code" href="classurbi_1_1_u_abstract_client.html#ac8bbfdfbfa8f47ed8f52e6725eede28f" title="The major version. -1 if not yet available.">kernelMajor_</a> = 2;
<a name="l01129"></a>01129       <a class="code" href="classurbi_1_1_u_abstract_client.html#a5b77875812f97c107bd59fef227cf048" title="The minor version. -1 if not yet available.">kernelMinor_</a> = 0;
<a name="l01130"></a>01130       GD_FWARN(<span class="stringliteral">&quot;failed to parse kernel version string: &#39;%s&#39;, assuming %s.%s.&quot;</span>,
<a name="l01131"></a>01131                <a class="code" href="classurbi_1_1_u_abstract_client.html#a244b05e3963f159224c586c3990285c5" title="The full kernel version as answered by the server.">kernelVersion_</a>,
<a name="l01132"></a>01132                <a class="code" href="classurbi_1_1_u_abstract_client.html#ac8bbfdfbfa8f47ed8f52e6725eede28f" title="The major version. -1 if not yet available.">kernelMajor_</a>,
<a name="l01133"></a>01133                <a class="code" href="classurbi_1_1_u_abstract_client.html#a5b77875812f97c107bd59fef227cf048" title="The minor version. -1 if not yet available.">kernelMinor_</a>);
<a name="l01134"></a>01134     }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136     <span class="comment">// Set the kernel version of our associated stream.</span><a class="code" href="namespaceurbi.html#a2c3c1981f73797a36ed8a27194a11066"></a>
<a name="l01137"></a>01137 <a class="code" href="namespaceurbi.html#a2c3c1981f73797a36ed8a27194a11066">    ::urbi::kernelMajor</a>(*this) = <a class="code" href="classurbi_1_1_u_abstract_client.html#ac8bbfdfbfa8f47ed8f52e6725eede28f" title="The major version. -1 if not yet available.">kernelMajor_</a>;
<a name="l01138"></a>01138 
<a name="l01139"></a>01139     <span class="comment">// Have the connectionId sent on __ident.</span>
<a name="l01140"></a>01140 <span class="preprocessor"># define IDENT_TAG TAG_PRIVATE_PREFIX &quot;__ident&quot;</span>
<a name="l01141"></a>01141 <span class="preprocessor"></span>    <a class="code" href="classurbi_1_1_u_abstract_client.html#a574c8f649ce663ebc5cd8211a01367aa" title="Associate a callback function with a tag. New style.">setCallback</a>(*<span class="keyword">this</span>, &amp;<a class="code" href="classurbi_1_1_u_abstract_client.html#a597b9f98b6e393bcd891064cec61835f" title="A callback, installed by setVersion, that computes connectionID_.">UAbstractClient::setConnectionID</a>, <a class="code" href="uabstractclient_8cc.html#aaf59b372c8aab2373c70000cd89db8e2">IDENT_TAG</a>);
<a name="l01142"></a>01142     <a class="code" href="group___sending.html#ga5f5836b7f8910ab9992eae177ffa435b" title="Send an Urbi command.">send</a>(<a class="code" href="classurbi_1_1_u_abstract_client.html#ac8bbfdfbfa8f47ed8f52e6725eede28f" title="The major version. -1 if not yet available.">kernelMajor_</a> &lt; 2
<a name="l01143"></a>01143          ? <a class="code" href="uabstractclient_8cc.html#aaf59b372c8aab2373c70000cd89db8e2">IDENT_TAG</a> <span class="stringliteral">&quot; &lt;&lt; local.connectionID;\n&quot;</span>
<a name="l01144"></a>01144          : <a class="code" href="uvalue_8hh.html#a68ff1679095cf52290483daa7da9b911">SYNCLINE_WRAP</a>(<span class="stringliteral">&quot;Channel.new(\&quot;&quot;</span> <a class="code" href="uabstractclient_8cc.html#aaf59b372c8aab2373c70000cd89db8e2">IDENT_TAG</a> <span class="stringliteral">&quot;\&quot;)&quot;</span>
<a name="l01145"></a>01145                          <span class="stringliteral">&quot; &lt;&lt; connectionTag.name;\n&quot;</span>));
<a name="l01146"></a>01146     <span class="keywordflow">return</span> URBI_REMOVE;
<a name="l01147"></a>01147 <span class="preprocessor"># undef IDENT_TAG</span>
<a name="l01148"></a>01148 <span class="preprocessor"></span>  }
<a name="l01149"></a>01149 
<a name="l01150"></a>01150   <span class="keywordtype">int</span>
<a name="l01151"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a80af6545138aa7b3901e79e99351176e">01151</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a80af6545138aa7b3901e79e99351176e">UAbstractClient::getCurrentTimestamp</a>()<span class="keyword"> const</span>
<a name="l01152"></a>01152 <span class="keyword">  </span>{
<a name="l01153"></a>01153     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#aec433c7c9c6985253fb83b8e3d1aed9a">currentTimestamp</a>;
<a name="l01154"></a>01154   }
<a name="l01155"></a>01155 
<a name="l01156"></a>01156   <span class="keyword">const</span> std::string&amp;
<a name="l01157"></a><a class="code" href="classurbi_1_1_u_abstract_client.html#a147a2b43d745ee210980ce0212d8aeb0">01157</a>   <a class="code" href="classurbi_1_1_u_abstract_client.html#a147a2b43d745ee210980ce0212d8aeb0">UAbstractClient::connectionID</a>()<span class="keyword"> const</span>
<a name="l01158"></a>01158 <span class="keyword">  </span>{
<a name="l01159"></a>01159     <span class="keywordflow">return</span> <a class="code" href="classurbi_1_1_u_abstract_client.html#abebd6241d4e9ad282535097c87ecf1e5">connectionID_</a>;
<a name="l01160"></a>01160   }
<a name="l01161"></a>01161 
<a name="l01162"></a>01162   std::string
<a name="l01163"></a>01163   <a class="code" href="namespaceurbi.html#a53d0d09d1fd5e64f574a0ef3829bab79">getClientConnectionID</a>(<span class="keyword">const</span> <a class="code" href="classurbi_1_1_u_abstract_client.html" title="Interface for an URBI wrapper object.">UAbstractClient</a>* cli)
<a name="l01164"></a>01164   {
<a name="l01165"></a>01165     <span class="keywordflow">if</span> (!cli)
<a name="l01166"></a>01166       <span class="keywordflow">return</span> <span class="stringliteral">&quot;&quot;</span>;
<a name="l01167"></a>01167     <span class="keywordflow">return</span> cli-&gt;<a class="code" href="classurbi_1_1_u_abstract_client.html#a147a2b43d745ee210980ce0212d8aeb0">connectionID</a>();
<a name="l01168"></a>01168   }
<a name="l01169"></a>01169 
<a name="l01170"></a>01170 
<a name="l01171"></a>01171   UAbstractClient*
<a name="l01172"></a><a class="code" href="namespaceurbi.html#afd5af773c0495c34d747f77496b512a7">01172</a>   <a class="code" href="namespaceurbi.html#afd5af773c0495c34d747f77496b512a7">client_get</a>(std::ostream&amp; o)
<a name="l01173"></a>01173   {
<a name="l01174"></a>01174     <span class="keywordflow">if</span> (UClientStreambuf* buf = dynamic_cast&lt;UClientStreambuf*&gt;(o.rdbuf()))
<a name="l01175"></a>01175       <span class="keywordflow">return</span> buf-&gt;client_get();
<a name="l01176"></a>01176     <span class="keywordflow">else</span>
<a name="l01177"></a>01177       <span class="keywordflow">return</span> 0;
<a name="l01178"></a>01178   }
<a name="l01179"></a>01179 
<a name="l01180"></a>01180 
<a name="l01181"></a>01181   <span class="comment">/*-----------------.</span>
<a name="l01182"></a>01182 <span class="comment">  | Default client.  |</span>
<a name="l01183"></a>01183 <span class="comment">  `-----------------*/</span>
<a name="l01184"></a>01184 
<a name="l01185"></a><a class="code" href="namespaceurbi.html#af6143e1abff0d602728d7e8f7765d3d7">01185</a>   <a class="code" href="classurbi_1_1_u_client.html" title="Linux implementation of UAbstractClient.">UClient</a>* <a class="code" href="namespaceurbi.html#af6143e1abff0d602728d7e8f7765d3d7">defaultClient</a> = 0;
<a name="l01186"></a>01186 
<a name="l01187"></a>01187   <a class="code" href="classurbi_1_1_u_client.html" title="Linux implementation of UAbstractClient.">UClient</a>* <a class="code" href="namespaceurbi.html#a9586227e53bd2feae43f1010afc1d6fa" title="Return the first UClient created by the program.">getDefaultClient</a>()
<a name="l01188"></a>01188   {
<a name="l01189"></a>01189     <span class="keywordflow">return</span> <a class="code" href="namespaceurbi.html#af6143e1abff0d602728d7e8f7765d3d7">defaultClient</a>;
<a name="l01190"></a>01190   }
<a name="l01191"></a>01191 
<a name="l01192"></a>01192   UClient&amp; <a class="code" href="namespaceurbi.html#ad560c2c311c507586fa7dc369add9861" title="Same as getDefaultClient(), but as a reference.">get_default_client</a>()
<a name="l01193"></a>01193   {
<a name="l01194"></a>01194     <span class="keywordflow">return</span> *<a class="code" href="namespaceurbi.html#a9586227e53bd2feae43f1010afc1d6fa" title="Return the first UClient created by the program.">getDefaultClient</a>();
<a name="l01195"></a>01195   }
<a name="l01196"></a>01196 
<a name="l01197"></a>01197   <span class="keywordtype">void</span> <a class="code" href="namespaceurbi.html#aef74fc0742be0966b175731a3806e8b0" title="Redefine the default client.">setDefaultClient</a>(UClient* cl)
<a name="l01198"></a>01198   {
<a name="l01199"></a>01199     <a class="code" href="namespaceurbi.html#af6143e1abff0d602728d7e8f7765d3d7">defaultClient</a> = cl;
<a name="l01200"></a>01200   }
<a name="l01201"></a>01201 
<a name="l01202"></a>01202 
<a name="l01203"></a>01203   std::ostream&amp;
<a name="l01204"></a>01204   <a class="code" href="namespaceurbi.html#a2727108bc30da885740831a68908abb0" title="Send a possibly armored string to the default client.">unarmorAndSend</a>(<span class="keyword">const</span> <span class="keywordtype">char</span>* a, UAbstractClient* where)
<a name="l01205"></a>01205   {
<a name="l01206"></a>01206     aver(a);
<a name="l01207"></a>01207     aver(where);
<a name="l01208"></a>01208     std::ostream&amp; s = *where;
<a name="l01209"></a>01209     <span class="keywordflow">if</span> (strlen(a)&gt;2)
<a name="l01210"></a>01210     {
<a name="l01211"></a>01211       <span class="keywordflow">if</span> (a[0]==<span class="charliteral">&#39;(&#39;</span> &amp;&amp; a[strlen(a)-1]==<span class="charliteral">&#39;)&#39;</span>)
<a name="l01212"></a>01212         s.rdbuf()-&gt;sputn(a+1, strlen(a)-2);
<a name="l01213"></a>01213       <span class="keywordflow">else</span>
<a name="l01214"></a>01214         s &lt;&lt; a; <span class="comment">//this is baaad, user forgot the parenthesis but was lucky</span>
<a name="l01215"></a>01215     }
<a name="l01216"></a>01216     <span class="keywordflow">return</span> s;
<a name="l01217"></a>01217   }
<a name="l01218"></a>01218 
<a name="l01219"></a>01219 } <span class="comment">// namespace urbi</span>
</pre></div></div>
</div>
<hr class="footer"/><address class="footer"><small>Generated by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
